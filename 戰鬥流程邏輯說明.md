# 戰鬥流程邏輯說明

## 執行前提

> **所有邏輯都在 `DungeonState.Combat` 狀態下執行**

---

## 修改位置

**檔案**: `src/script.py`  
**函數**: `StateCombat()`  

---

## 戰鬥主流程

```
【StateCombat() 被呼叫】
│
├─ 1. 初始化
│     ├─ 記錄戰鬥開始時間（若尚未記錄）
│     └─ 檢查並開啟 2 倍速（combatSpd）
│
├─ 2. 檢查施法序列 (_ACTIVESPELLSEQUENCE)
│     │
│     ├─ 有施法序列 → 進入【施法序列處理】
│     │
│     └─ 無施法序列 → 進入步驟 3
│
├─ 3. ★ 重啟後前2次戰鬥 (_FIRST_COMBAT_AFTER_RESTART > 0)
│     │  【優先於自動戰鬥！】
│     │
│     ├─ 功能已啟用 (_FORCE_PHYSICAL_FIRST_COMBAT = True)
│     │     ├─ 打斷自動戰鬥（點擊畫面空白處）
│     │     ├─ 使用強力單體技能 → 結束
│     │     └─ 找不到技能 → 進入步驟 5
│     │
│     └─ 功能已關閉 → 進入步驟 4
│
├─ 4. ★ 村莊返回後前2次戰鬥 (_FIRST_COMBAT_AFTER_INN > 0)
│     │  【優先於自動戰鬥！】
│     │
│     ├─ 功能已啟用 (_FORCE_PHYSICAL_AFTER_INN = True)
│     │     ├─ 打斷自動戰鬥（點擊畫面空白處）
│     │     ├─ 使用強力單體技能 → 結束
│     │     └─ 找不到技能 → 進入步驟 5
│     │
│     └─ 功能已關閉 → 進入步驟 5
│
├─ 5. 檢查自動戰鬥模式
│     │
│     ├─ 系統自動戰鬥啟用 (_SYSTEMAUTOCOMBAT = True)
│     │     → 點擊自動戰鬥按鈕 → 結束
│     │
│     ├─ AOE 後自動戰鬥 (_ENOUGH_AOE = True 且 _AUTO_AFTER_AOE = True)
│     │     → 點擊自動戰鬥按鈕 → 結束
│     │
│     └─ 都不是 → 進入步驟 6
│
├─ 6. 確認戰鬥畫面（檢查 flee 按鈕）
│     │
│     └─ 未找到 flee 按鈕 → 結束（等待下次呼叫）
│
├─ 7. 檢查特殊狀態
│     │
│     ├─ 自殺模式 (_SUICIDE = True)
│     │     → 使用防禦技能 (defend)
│     │
│     └─ 正常戰鬥
│           → 進入【正常技能釋放流程】
│
└─ 結束
```

---

## 施法序列處理

```
【施法序列處理】
│
├─ 遍歷序列中的每個角色特徵 (key)
│     │
│     ├─ 畫面中檢測到該角色 (spellskill/key)
│     │     │
│     │     ├─ 檢查目標技能是否可用
│     │     │     │
│     │     │     ├─ 可用 → 釋放技能 → 確認施法
│     │     │     │         → 從序列中移除已用技能（若非最後一個）
│     │     │     │
│     │     │     └─ 不可用 → 記錄錯誤 → 點擊空白處退出
│     │     │
│     │     └─ 結束
│     │
│     └─ 未檢測到該角色 → 繼續遍歷
│
└─ 無匹配 → 進入步驟 3
```

---

## 強力單體技能處理 (useForcedPhysicalSkill)

> **觸發條件**：重啟後前2次戰鬥 或 村莊返回後前2次戰鬥

```
【強力單體技能處理】
│
├─ 記錄日誌：{原因}，强制使用强力单体技能
│
├─ ★ 打斷自動戰鬥
│     └─ 點擊畫面空白處 [1,1] 三次，每次間隔 0.5 秒
│
├─ 遍歷 PHYSICAL_SKILLS 列表
│     │
│     ├─ 找到可用技能
│     │     → 釋放技能 → 確認施法 → 返回 True
│     │
│     └─ 遍歷完畢都未找到
│           → 記錄：未找到可用的强力单体技能
│           → 返回 False（繼續正常流程）
│
└─ 結束
```

---

## 正常技能釋放流程

```
【正常技能釋放】
│
├─ 遍歷 _SPELLSKILLCONFIG 中的技能
│     │
│     ├─ 檢查 AOE 限制
│     │     │
│     │     ├─ _ENOUGH_AOE = True 且 技能是全體 AOE
│     │     │     → 跳過此技能（繼續下一個）
│     │     │
│     │     └─ 否則 → 繼續檢測
│     │
│     ├─ 技能在畫面中可用
│     │     │
│     │     ├─ 釋放技能 → 確認施法
│     │     │
│     │     ├─ 如果是全體 AOE 且 _AOE_ONCE 啟用
│     │     │     → 設置 _ENOUGH_AOE = True
│     │     │
│     │     └─ 結束
│     │
│     └─ 技能不可用 → 繼續遍歷
│
├─ 遍歷完畢都未釋放技能
│     → 關閉技能面板
│     → 點擊空白處（讓戰鬥繼續）
│
└─ 結束
```

---

## 確認施法處理 (doubleConfirmCastSpell)

```
【確認施法】
│
├─ 等待 1 秒
│
├─ 截圖檢測
│     │
│     ├─ 找到 OK 按鈕
│     │     ├─ 點擊 OK
│     │     ├─ 標記為 AOE 成功
│     │     └─ 檢查 SP/MP 不足
│     │           ├─ 不足 → 關閉提示 → 選擇 lv1 技能 → 重新確認
│     │           └─ 足夠 → 繼續
│     │
│     ├─ 找到 next 按鈕（多目標選擇）
│     │     ├─ 點擊目標位置（隨機偏移）
│     │     └─ 檢查 SP/MP 不足（同上處理）
│     │
│     └─ 都沒找到
│           → 點擊 6 個角色位置（依次點擊確認）
│
└─ 返回是否 AOE 成功
```

---

## 技能分類

| 分類 | 變數名 | 技能列表 |
|------|--------|----------|
| **控場技能** | `CC_SKILLS` | KANTIOS |
| **秘術 AOE** | `SECRET_AOE_SKILLS` | SAoLABADIOS, SAoLAERLIK, SAoLAFOROS |
| **全體 AOE** | `FULL_AOE_SKILLS` | LAERLIK, LAMIGAL, LAZELOS, LACONES, LAFOROS, LAHALITO, LAFERU, 千恋万花 |
| **橫排 AOE** | `ROW_AOE_SKILLS` | maerlik, mahalito, mamigal, mazelos, maferu, macones, maforos, 终焉之刻 |
| **強力單體** | `PHYSICAL_SKILLS` | unendingdeaths, 全力一击, tzalik, 居合, 精密攻击, 锁腹刺, 破甲, 星光裂, 迟钝连携击, 强袭, 重装一击, 眩晕打击, 幻影狩猎 |

---

## 關鍵參數

| 參數 | 說明 |
|------|------|
| `_SYSTEMAUTOCOMBAT` | 系統自動戰鬥開關 |
| `_AOE_ONCE` | 每場戰鬥只釋放一次全體 AOE |
| `_AUTO_AFTER_AOE` | AOE 後開啟自動戰鬥 |
| `_ENOUGH_AOE` | 本場戰鬥是否已釋放全體 AOE |
| `_SUICIDE` | 自殺模式（全員防禦等死） |
| `_FORCE_PHYSICAL_FIRST_COMBAT` | 重啟後前2次戰鬥使用強力單體技能開關 |
| `_FORCE_PHYSICAL_AFTER_INN` | 返回後前2次戰鬥使用強力單體技能開關 |
| `_FIRST_COMBAT_AFTER_RESTART` | 重啟後戰鬥計數器（初始=2，每次戰鬥-1） |
| `_FIRST_COMBAT_AFTER_INN` | 返回後戰鬥計數器（初始=2，每次戰鬥-1） |
| `_SPELLSKILLCONFIG` | 使用者配置的技能列表 |
| `_ACTIVESPELLSEQUENCE` | 施法序列（特定副本使用） |

---

## RuntimeContext 戰鬥相關變數

| 變數 | 類型 | 預設值 | 說明 |
|------|------|--------|------|
| `_TIME_COMBAT` | float | 0 | 戰鬥開始時間戳 |
| `_COMBATSPD` | bool | False | 是否已開啟 2 倍速 |
| `_ENOUGH_AOE` | bool | False | 本場是否已釋放全體 AOE |
| `_SUICIDE` | bool | False | 自殺模式標誌 |
| `_FIRST_COMBAT_AFTER_RESTART` | int | 0 | 重啟後戰鬥計數器（restartGame時設為2） |
| `_FIRST_COMBAT_AFTER_INN` | int | 0 | 返回後戰鬥計數器（每次進入地城時設為2） |
| `_FORCE_PHYSICAL_CURRENT_COMBAT` | bool | False | 當前戰鬥是否使用強力單體技能 |
| `_COUNTERCOMBAT` | int | 0 | 戰鬥次數統計 |

---

## 設定說明

### GUI 控制項

| 設定 | 效果 |
|------|------|
| ✅ 啟用自動戰鬥 | 直接點擊自動戰鬥按鈕，不執行技能邏輯 |
| ✅ 一場戰鬥中僅釋放一次全體 AOE | 釋放後跳過後續 AOE 技能 |
| ✅ 全體 AOE 後開啟自動戰鬥 | AOE 後自動切換為自動戰鬥模式 |

---

## 戰鬥結束後重置

在 `DungeonState.Dungeon` 狀態中（第 1792 行）：

```python
if setting._AOE_ONCE:
    runtimeContext._ENOUGH_AOE = False  # 重置 AOE 標誌，下場戰鬥可再次釋放
```
