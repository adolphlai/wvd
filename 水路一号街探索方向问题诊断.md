# 水路一号街探索方向问题诊断

## 🔍 问题分析

您说"实际使用时没有四方向探索"，可能的原因有以下几个：

---

## 可能原因1：历史记录优化导致方向被跳过 ⚠️

**最可能的原因！**

### 问题机制

历史记录优化会在**第4次运行**后开始跳过某些方向：

```python
# 历史记录逻辑（chest_direction_history.py）
if attempts >= 3 and found == 0:
    return False  # 跳过此方向
```

### 检查方法

1. **查看历史记录文件：**
   - 文件位置：`chest_direction_history.json`（项目根目录）
   
2. **检查内容：**
   ```json
   {
     "Dist": {
       "chest": {
         "中央": {"attempts": 3, "found": 1},
         "左上": {"attempts": 3, "found": 0},  ← 这个会被跳过！
         "右上": {"attempts": 3, "found": 0},  ← 这个会被跳过！
         "右下": {"attempts": 1, "found": 0},
         "左下": {"attempts": 2, "found": 0}
       }
     }
   }
   ```

3. **判断标准：**
   - `attempts >= 3` **且** `found == 0` → **会被跳过**
   - `attempts < 3` → **继续搜索**（还在收集数据）
   - `found > 0` → **继续搜索**（曾经找到过）

### 解决方案

**方案A：删除历史记录文件（重置）**
```bash
# 删除文件
删除 chest_direction_history.json
```

**方案B：手动编辑历史记录**
```json
{
  "Dist": {
    "chest": {
      "左上": {"attempts": 0, "found": 0},  // 重置为0，强制搜索
      "右上": {"attempts": 0, "found": 0},
      "右下": {"attempts": 0, "found": 0},
      "左下": {"attempts": 0, "found": 0}
    }
  }
}
```

**方案C：修改代码，禁用优化（临时）**
在 `src/script.py` 的 `StateMap_FindSwipeClick` 函数中，注释掉历史记录检查：
```python
# 注释掉这段代码（约1389-1395行）
# if direction_history is not None:
#     dungeon_name = setting._FARMTARGET
#     should_search = direction_history.should_search_direction(dungeon_name, swipeDir, target=target)
#     if not should_search:
#         direction_name = direction_history._normalize_direction(swipeDir)
#         logger.info(f"{target}優化: 方向 [{direction_name}] 已確認無目標，跳過")
#         continue
```

---

## 可能原因2：中央方向找到宝箱，立即停止搜索 ⚠️

### 问题机制

代码逻辑：**找到第一个宝箱后立即 `break`，不再搜索其他方向**

```python
# StateMap_FindSwipeClick 中（约1421行）
if targetPos:=CheckIf(scn,target,roi):
    logger.info(f'[{direction_name}] 找到 {target}!')
    break  # ← 立即退出循环，不再搜索其他方向
```

### 搜索顺序

默认顺序（`swipeDir=None` 时）：
1. **中央**（不滑动）- 如果这里有宝箱，**其他方向都不会搜索**
2. 左上
3. 右上
4. 右下
5. 左下

### 检查方法

查看日志输出：
```
> 搜索方向: [中央]
[中央] 找到 chest!  ← 如果这里就找到，就不会继续搜索其他方向
```

### 解决方案

**方案A：跳过中央方向**

修改 `resources/quest/quest.json`：
```json
"Dist": {
    "_TYPE": "dungeon",
    "questName": "[宝箱]水路一号街",
    "_TARGETINFOLIST": [
        ["chest", "左上", null],   // 只搜索左上
        ["chest", "右上", null],   // 然后搜索右上
        ["chest", "左下", null],   // 然后搜索左下
        ["chest", "右下", null],   // 然后搜索右下
        ["harken"]
    ],
    "_EOT": [
        ["press", "TradeWaterway", ["EdgeOfTown", [1,1]], 1],
        ["press", "Dist", "input swipe 650 250 650 900", 1]
    ]
}
```

**方案B：修改搜索顺序（需要改代码）**

修改 `src/script.py` 的 `TargetInfo.swipeDir` setter，调整默认顺序：
```python
case None:
    # 跳过中央，直接搜索4个方向
    value = [
        [100,250,700,1200],   # 左上
        [700,250,100,1200],   # 右上
        [700,1200,100,250],   # 右下
        [100,1200,700,250],   # 左下
        None                  # 中央放在最后
    ]
```

---

## 可能原因3：配置解析问题

### 检查配置是否正确加载

查看日志中是否有：
```
启动任务"[宝箱]水路一号街"...
```

确认 `setting._FARMTARGET` 的值：
- 应该是 `"Dist"`（配置的key）
- 如果不是，可能是配置加载问题

### 检查 TargetInfo 构建

在 `src/script.py` 第408行：
```python
setattr(quest, key, [TargetInfo(*args) for args in value])
```

对于 `["chest"]`：
- `args = ["chest"]`
- 会调用 `TargetInfo("chest", None, None)`
- `swipeDir=None` 会被转换为默认的5个方向

**这个应该是正常的！**

---

## 🔧 完整诊断步骤

### 步骤1：检查历史记录文件

```bash
# 查看文件是否存在
cat chest_direction_history.json

# 或者用文本编辑器打开
```

**如果没有文件：** 说明是第一次运行，历史记录不是问题

**如果有文件：** 检查 `"Dist"` 下的 `"chest"` 数据

### 步骤2：查看日志输出

在脚本运行时，查看日志文件（`logs/log_*.txt`），寻找：

```
> 搜索方向: [中央]
> 滑动地图: [左上]
> 滑动地图: [右上]
> 滑动地图: [右下]
> 滑动地图: [左下]
```

**如果只看到：**
```
> 搜索方向: [中央]
[中央] 找到 chest!
```
→ **说明中央找到宝箱，其他方向没搜索**

**如果看到：**
```
> 搜索方向: [中央]
[中央] 没找到 chest
chest優化: 方向 [左上] 已確認無目標，跳過
chest優化: 方向 [右上] 已確認無目標，跳過
...
```
→ **说明历史记录优化跳过了这些方向**

### 步骤3：测试重置历史记录

1. **删除 `chest_direction_history.json`**
2. **重新运行脚本**
3. **观察是否搜索所有方向**

如果重置后可以搜索所有方向，说明问题确实是历史记录优化。

---

## 🎯 推荐的解决方案

### 方案1：修改配置，明确指定方向（推荐）

修改 `resources/quest/quest.json`：
```json
"Dist": {
    "_TYPE": "dungeon",
    "questName": "[宝箱]水路一号街",
    "_TARGETINFOLIST": [
        ["chest", "左上", null],
        ["chest", "右上", null],
        ["chest", "左下", null],
        ["chest", "右下", null],
        ["harken"]
    ],
    "_EOT": [
        ["press", "TradeWaterway", ["EdgeOfTown", [1,1]], 1],
        ["press", "Dist", "input swipe 650 250 650 900", 1]
    ]
}
```

**优点：**
- 不需要修改代码
- 明确控制搜索方向
- 可以跳过中央方向（如果中央总是有宝箱）
- 每个方向都会独立搜索，不会被"找到就停止"的逻辑影响

**缺点：**
- 如果有多个方向的宝箱，会按顺序搜索，不是同时找到所有宝箱

### 方案2：调整历史记录优化参数

修改 `src/chest_direction_history.py` 第53行：
```python
def should_search_direction(self, dungeon_name, direction, target='chest', min_attempts=10):  # 从3改为10
```

**优点：**
- 需要更多次尝试才跳过方向
- 降低误跳过的概率

**缺点：**
- 仍然可能跳过某些方向

### 方案3：禁用历史记录优化（临时）

在 `src/script.py` 中临时注释掉优化逻辑（见上面的代码）

**优点：**
- 完全禁用优化，确保搜索所有方向

**缺点：**
- 每次都会搜索所有方向，效率可能降低
- 修改代码后需要重新打包

---

## 📊 预期行为对比

### 正常行为（5个方向都搜索）

```
> 搜索方向: [中央]
[中央] 没找到 chest

> 滑动地图: [左上]
[左上] 没找到 chest

> 滑动地图: [右上]
[右上] 找到 chest!
```

### 异常行为1（中央找到，其他方向不搜索）

```
> 搜索方向: [中央]
[中央] 找到 chest!
（停止，不搜索其他方向）
```

### 异常行为2（历史记录跳过方向）

```
> 搜索方向: [中央]
[中央] 没找到 chest

chest優化: 方向 [左上] 已確認無目標，跳過
chest優化: 方向 [右上] 已確認無目標，跳過
chest優化: 方向 [右下] 已確認無目標，跳過

> 滑动地图: [左下]
[左下] 没找到 chest
```

---

## ✅ 验证修复

修复后，检查日志应该看到：

```
> 搜索方向: [中央]
[中央] 没找到 chest

> 滑动地图: [左上]
[左上] 找到/没找到 chest

> 滑动地图: [右上]
[右上] 找到/没找到 chest

> 滑动地图: [右下]
[右下] 找到/没找到 chest

> 滑动地图: [左下]
[左下] 找到/没找到 chest
```

---

## 💡 建议

**最推荐的方案：** 修改配置文件，明确指定4个方向（左上、右上、左下、右下），跳过中央方向。

这样：
1. 不受历史记录优化影响
2. 不受"找到就停止"逻辑影响
3. 每个方向独立搜索
4. 不需要修改代码

