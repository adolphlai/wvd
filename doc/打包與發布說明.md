# 打包與發布說明

> [!CAUTION]
> **AI 助手請注意**：由於 pyscrcpy/av 無法在 GitHub Actions CI 環境安裝，每次發布新版本時必須**提醒用戶手動執行本地打包並上傳**到 GitHub Release，否則 Release 版本將不包含串流截圖功能。
> 
> **發布流程**：
> 1. 更新版本號 → 提交 → 推送 tag（觸發 CI）
> 2. **CI 完成後**，用戶需運行 `localpack.bat` 本地打包
> 3. 將 `dist/wvd/` 壓縮為 `wvd.zip`
> 4. 到 GitHub Release 頁面**手動上傳替換** CI 生成的 wvd.zip

## 本地打包

### 使用方式

運行 `localpack.bat` 腳本進行本地打包：

```batch
localpack.bat
```

### 前置條件

1. 安裝 Anaconda
2. 創建名為 `vpy` 的虛擬環境
3. 修改 `localpack.bat` 中的 `ANACONDA_PATH` 為你的 Anaconda 路徑
4. **（可選）安裝 pyscrcpy 串流支援**：
   ```bash
   pip install pyscrcpy av
   ```

### 輸出

打包完成後，可執行文件位於：`dist/wvd/wvd.exe`

### 包含 pyscrcpy 串流功能

由於 pyscrcpy/av 在 GitHub Actions CI 環境無法安裝，需要使用本地打包來生成包含串流功能的版本：

1. 確保虛擬環境已安裝 `pyscrcpy` 和 `av`
2. 運行 `localpack.bat` 打包
3. 將 `dist/wvd/` 壓縮為 `wvd.zip`
4. 前往 GitHub Release 頁面手動上傳 `wvd.zip` 替換 CI 生成的版本

---

## GitHub Actions 自動打包與發布

### 觸發條件

**只有推送 v 開頭的 tag 時才會觸發**，例如：`v1.9.25`

推送代碼到 master **不會**觸發發布流程。

### 工作流程

1. 從 `src/main.py` 提取版本號（`__version__`）
2. 安裝依賴並使用 PyInstaller 打包
3. 創建 `wvd.zip` 壓縮包
4. 創建 GitHub Release 並上傳 ZIP
5. 如果版本號包含 `-`（如 `-beta.1`），標記為 Pre-release

---

## 發布新版本步驟

### 1. 更新版本號

編輯 `src/main.py` 中的 `__version__`：

```python
__version__ = '1.9.26'  # 正式版（顯示為 Latest）
# 或
__version__ = '1.9.26-beta.1'  # 預發布版（顯示為 Pre-release）
```

**注意**：代碼中的版本號**不帶 `v` 前綴**，workflow 會自動加上。

### 2. 提交並推送代碼

```bash
git add -A
git commit -m "release: v1.9.26"
git push origin master
```

此時 **不會** 觸發發布流程。

### 3. 創建並推送 Tag

```bash
git tag v1.9.26
git push origin v1.9.26
```

此時 **會** 觸發發布流程，自動創建 Release。

### 4. 查看構建狀態

前往 https://github.com/adolphlai/wvd/actions

---

## 版本號規則

| 代碼版本號 | Git Tag | Release 標題 | 狀態 |
|-----------|---------|-------------|------|
| `1.9.25` | `v1.9.25` | `Release v1.9.25` | **Latest** |
| `1.9.25-beta.1` | `v1.9.25-beta.1` | `Release v1.9.25-beta.1` | Pre-release |
| `1.9.25-custom.2` | `v1.9.25-custom.2` | `Release v1.9.25-custom.2` | Pre-release |

**規則**：版本號包含 `-` 就是 Pre-release

---

## 重新發布同一版本

如果需要更新同一版本的 Release：

```bash
# 1. 刪除本地和遠程 tag
git tag -d v1.9.25
git push origin :refs/tags/v1.9.25

# 2. 重新創建並推送
git tag v1.9.25
git push origin v1.9.25
```

---

## 手動觸發

在 GitHub Actions 頁面可以手動觸發 workflow：

1. 前往 https://github.com/adolphlai/wvd/actions
2. 選擇 "Build Executable and Create Release"
3. 點擊 "Run workflow"
