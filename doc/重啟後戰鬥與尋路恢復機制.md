# 遊戲崩潰重啟後狀態恢復機制分析 (戰鬥與自動尋路)

本文件詳細說明腳本在遭遇遊戲崩潰或手動觸發 `restartGame()` 後，如何維護戰鬥計數與自動尋路邏輯的連貫性與魯棒性。

## 1. 重啟核心標誌位初始化 (`restartGame`)

當 `restartGame()` 被調用時，會設置以下關鍵標誌位，這些標誌位引導後續的恢復行為：

| 標誌位 | 說明 | 恢復目的 |
| :--- | :--- | :--- |
| `_STEPAFTERRESTART = False` | 防轉圈/防卡死標誌 | 觸發 `StateDungeon` 中的「前後左右」平移補償。 |
| `_RESTART_OPEN_MAP_PENDING = True`| 強制開地圖標誌 | 禁止 `DungeonMover` 使用 Resume 優化，確保目標重新鎖定。 |
| `_RESTART_PENDING_BATTLE_RESET = True` | 戰鬥計數重置標誌 | 確保重啟後的第一場戰鬥被識別為「首戰」。 |
| `_RESTART_SKIP_INTERVAL_THIS_DUNGEON = True` | 跳過間隔檢查標誌 | 確保重啟後當前地城的自動戰鬥模式能正常啟動。 |
| `_DUNGEON_CONFIRMED = False` | 地城確認標誌 | 防止在狀態尚未穩定前觸發黑屏檢測。 |

---

## 2. 戰鬥邏輯恢復機制 (`StateCombat`)

### 2.1 戰鬥循環重置
在 `StateCombat` 入口處，腳本會檢查 `_RESTART_PENDING_BATTLE_RESET`：
- **行為**：將 `_COMBAT_BATTLE_COUNT` (總戰鬥數) 與 `_COMBAT_ACTION_COUNT` (單戰行動數) 歸零。
- **影響**：這使得技能施放邏輯（如「首戰施放」、「第一回合施放」）在重啟後能準確執行，避免因中途崩潰導致計數錯亂。

### 2.2 自動戰鬥強制啟動
在 `should_enable_auto_combat` 中，會檢查 `_RESTART_SKIP_INTERVAL_THIS_DUNGEON`：
- **背景**：用戶可能設置了「每 N 次地城啟動一次 AE」。
- **問題**：若重啟時該計數不匹配，可能導致自動戰鬥未開啟而卡死。
- **恢復**：若該標誌為 `True`，腳本會跳過間隔匹配判斷，直接根據當前戰鬥序號執行 `_AUTO_COMBAT_MODE` 設定，確保效率。

---

## 3. 自動尋路恢復機制 (`DungeonMover`)

重啟後的移動策略遵循「**安全優先，放棄優化**」原則。

### 3.1 防轉圈補償 (`StateDungeon`)
在進入尋路前，若 `_STEPAFTERRESTART` 為 `False`：
- **補償動作**：執行「上移(前進) -> 下移(後退) -> 左移 -> 右移」。
- **目的**：消除遊戲引擎可能存在的微小位移誤差或動畫卡頓，確保角色處於可移動狀態。執行後設置 `_STEPAFTERRESTART = True`。

### 3.2 禁用 Resume 優化
`DungeonMover.resume_navigation` 會檢查 `_RESTART_OPEN_MAP_PENDING`：
- **一般情況**：若戰鬥結束，腳本優先尋找畫面上的「Resume」按鈕以快速恢復移動（延續之前的導航路徑）。
- **重啟後**：由於遊戲重新啟動，「Resume」按鈕可能失效或導航路徑丟失。此時腳本會**跳過 Resume 檢測**，改為執行完整的地圖導航流程：
  1. 打開地圖
  2. 使用 `StateMap_FindSwipeClick(target_info)` 搜索 **`targetInfoList[0]` 中當前待執行的目標**（例如 `position`、`harken`、`stair` 等）
  3. 點擊找到的目標
  4. 點擊 AUTO 啟動移動
- **重新賦能**：只有當地圖上的目標被成功點擊並啟動移動後（Line 4333），才會將 `_RESTART_OPEN_MAP_PENDING` 設回 `False`，恢復後續戰鬥後的快速 Resume 行為。

### 3.3 目標列表 (`targetInfoList`) 的連續性
- **重啟後目標保留**：`targetInfoList` 是在 `DungeonFarm` 初始化時載入的，`restartGame()` 不會清空該列表。
- **導航延續**：這意味著重啟後，腳本會繼續從 `targetInfoList` 的第一個未完成目標開始導航，而非重新載入整個任務。


---

## 4. 狀態識別與安全性 (`IdentifyState`)

- **確認重置**：`_DUNGEON_CONFIRMED` 被重置為 `False`。
- **識別流程**：重啟後，腳本會從頭識別遊戲路徑。只有當再次看到 `dungFlag` 或 `mapFlag` 時，才會重新設置 `_DUNGEON_CONFIRMED = True`。
- **黑屏保護**：黑屏偵測邏輯（用於處理戰鬥轉場）僅在 `_DUNGEON_CONFIRMED` 為 `True` 時生效。這防止了重啟過程中因加載介面黑屏而錯誤觸發暫停。

---

## 5. 總結

重啟機制的設計核心是**重置狀態機的已知點**。通過強制性的物理位移補償、計數器歸零以及路徑重新導覽，確保了即使在最惡劣的崩潰情況下，腳本也能在重新啟動後的 30 秒內恢復正常的自動化循環。
