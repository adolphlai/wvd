# Quest.json 配置說明

本文檔說明 `resources/quest/quest.json` 的配置格式和所有可用選項。

---

## 任務結構

每個任務是一個 JSON 物件，格式如下：

```json
"任務ID": {
    "_TYPE": "dungeon",
    "questName": "顯示在 GUI 的名稱",
    "_TARGETINFOLIST": [...],
    "_EOT": [...],
    "_preEOTcheck": "可選",
    "_SPELLSEQUENCE": {...}
}
```

### 欄位說明

| 欄位 | 必需 | 說明 |
|------|------|------|
| `questName` | ✓ | 顯示在 GUI 下拉選單的名稱 |
| `_TYPE` | ✓ | `"dungeon"` 或 `"quest"` |
| `_TARGETINFOLIST` | dungeon 必需 | 目標點列表 |
| `_EOT` | dungeon 必需 | 離開地城後的操作 |
| `_preEOTcheck` | 可選 | 執行 `_EOT` 前檢查的圖片 |
| `_SPELLSEQUENCE` | 可選 | 自定義施法序列 |

---

## _TARGETINFOLIST 目標點

每個目標點格式：`[目標類型, 滑動方向, ROI/座標]`

### 目標類型 (target)

#### 1. `position` - 走到指定座標

```json
["position", "右下", [713, 1027]]
```

**行為**：
- 在地圖上尋找指定座標
- 檢查該座標處是否有「光標」（cursor_0 ~ cursor_3）
- **有光標** → 已經在這個位置 → 跳過
- **沒光標** → 走到這個位置

**用途**：走到地圖上的固定位置，通常用於過路點。

---

#### 2. `stair_XXX` - 尋找並通過樓梯

```json
["stair_fortress1f", "左上", [720, 395]]
```

**內建樓梯類型**：
- `stair_up` - 向上樓梯
- `stair_down` - 向下樓梯
- `stair_teleport` - 傳送點

**自定義樓梯**：
- `stair_fortress1f` - 要塞1F標識
- `stair_DH_R5` - 深雪R5標識
- 等等...（需要對應 `resources/images/stair_XXX.png`）

**行為（內建樓梯）**：
- 檢查指定座標處是否有樓梯圖標
- **有樓梯** → 還沒通過 → 走過去
- **沒樓梯** → 已經通過 → 跳過

**行為（自定義樓梯）**：
- 檢查螢幕上是否有「樓層標識圖片」（`stair_XXX.png`）
- **匹配** → 已經在目標樓層 → 跳過
- **不匹配** → 還沒到 → 走過去

---

#### 2.5 `minimap_stair` - 小地圖樓梯偵測（Resume 優化模式用）

```json
["minimap_stair", "右下", [73,1240], "DH-R5-minimap"]
```

**參數說明**：

| 參數 | 說明 |
|------|------|
| 第1個 | `"minimap_stair"` 固定值 |
| 第2個 | 滑動方向（`"左上"`, `"右下"` 等） |
| 第3個 | 樓梯在大地圖上的座標 `[x, y]` |
| 第4個 | 小地圖中的樓層標識圖片名稱（如 `"DH-R5-minimap"`） |

**行為**：
- 點擊樓梯座標開始移動
- **持續監控主畫面右上角小地圖**
- 偵測到樓層標識 → 確認已到達目標樓層 → 彈出目標

**用途**：在 Resume 優化模式下無法使用傳統 `stair_XXX` 偵測時的替代方案。

**依賴圖片**：需要 `resources/images/DH-R5-minimap.png` 等小地圖樓層標識圖片。

---

#### 3. `chest` - 搜索寶箱

```json
["chest", "左上", [[0,0,900,1600]]]
```

**行為**：
- 在地圖上搜索 `chest.png` 圖片
- 找到後走過去開箱
- 自動添加 UI 排除區域避免誤觸

**ROI 參數**：
- `null` → 全螢幕搜索
- `[[x,y,w,h]]` → 限制搜索區域
- `[[x,y,w,h], [x2,y2,w2,h2], ...]` → 多個搜索/排除區域

---

#### 4. `harken` - 尋找哈肯

**基本用法（返回城鎮）**：

```json
["harken", "左下", null]
```

**進階用法（樓層選擇）**：

```json
["harken", "方向", ROI, "樓層圖片名稱"]
```

**參數說明**：

| 參數 | 說明 |
|------|------|
| 第一個 | `"harken"` 固定值 |
| 第二個 | 滑動方向（`"左上"`, `"右下"` 等，或 `null`） |
| 第三個 | ROI 搜索區域限制（`null` 為全螢幕，`[[x,y,w,h]]` 為限制區域） |
| 第四個 | 樓層圖片名稱（可選，如 `"DH-R5"`，對應 `images/DH-R5.png`） |

**範例**：

```json
// 返回城鎮（無樓層選擇）
["harken", "左上", null]

// 返回城鎮，限制搜索區域
["harken", "右上", [[750, 850, 150, 150]]]

// 跳到指定樓層（如 DH-R5），限制搜索區域
["harken", "右上", [[750, 850, 150, 150]], "DH-R5"]

// 跳到指定樓層，不限制搜索區域
["harken", "左上", null, "DH-R6"]
```

**行為**：
- 在地圖上搜索 `harken.png` 或 `harken2.png` 等圖片（自動嘗試所有 `harken*.png`，選擇匹配度最高的）
- 找到後走過去觸發哈肯傳送
- **如果設定了樓層圖片**：傳送後點擊對應的樓層按鈕（而非返回城鎮）
- **如果沒有樓層圖片**：傳送後點擊返回城鎮

**多模板匹配**：
- 搜索 `harken` 時會自動嘗試 `harken.png`, `harken2.png`, `harken3.png` 等
- 選擇匹配度最高的模板
- 新增 harken 圖片只需放入 `resources/images/` 並命名為 `harken數字.png`

**用途**：地城任務的目標點，用於返回城鎮或跳轉到其他樓層。

---

#### 5. 自定義圖片識別

```json
["SSC/SSC_quit", "左下", "default"]
```
```json
["DOE_quit", null, null]
```

**行為**：
- 在地圖上搜索 `resources/images/XXX.png` 圖片
- 找到後點擊該位置

**用途**：離開特殊區域、觸發特定事件等。

---

### 滑動方向 (swipeDir)

| 值 | 說明 | 實際滑動 |
|----|------|---------|
| `null` | 全方向搜索（6個方向） | 依序嘗試所有方向 |
| `"左上"` | 地圖滑動到左上 | `[100,250,700,1200]` |
| `"右上"` | 地圖滑動到右上 | `[700,250,100,1200]` |
| `"左下"` | 地圖滑動到左下 | `[100,1200,700,250]` |
| `"右下"` | 地圖滑動到右下 | `[700,1200,100,250]` |
| 自定義陣列 | 自訂滑動路徑 | `[[x1,y1,x2,y2], ...]` |

---

### ROI 參數

| 值 | 說明 |
|----|------|
| `null` | 全螢幕搜索 |
| `[x, y]` | 指定座標（用於 position/stair） |
| `[[x,y,w,h]]` | 限制搜索區域 |
| `[[x,y,w,h], [x2,y2,w2,h2]]` | 多區域（第一個搜索，其餘排除） |
| `"default"` | 預設排除區域（排除 UI 元素） |

---

## _EOT 結束動作

地城完成後執行的操作序列，用於返回城鎮並重新進入地城。

格式：`["動作", "圖片名稱", "回退操作", 等待時間]`

### 範例

```json
"_EOT": [
    ["press", "TradeWaterway", ["EdgeOfTown", [1,1]], 1],
    ["press", "Dist", "input swipe 650 250 650 900", 1]
]
```

### 動作類型

| 動作 | 說明 |
|------|------|
| `"press"` | 點擊指定圖片 |

### 回退操作 (Fallback)

如果目標圖片找不到，執行的備用操作：

| 格式 | 說明 |
|------|------|
| `["圖片", [x,y]]` | 先按座標 `[x,y]`，等待圖片出現 |
| `"input swipe x1 y1 x2 y2"` | 執行 ADB 滑動命令 |
| `[1,1]` | 按左上角（關閉對話框等） |

---

## _SPELLSEQUENCE 施法序列

為特定戰鬥設定的自定義技能順序：

```json
"_SPELLSEQUENCE": {
    "LACONES": ["LACONES", "LACONES", "LACONES", "defend"],
    "居合": ["defend", "居合"]
}
```

### 格式

```
"識別技能": ["第一回合技能", "第二回合技能", ..., "循環技能"]
```

- **識別技能**：當畫面上出現這個技能時觸發序列
- **技能列表**：依序使用的技能，最後一個會一直循環

---

## _TYPE 任務類型

### `dungeon` - 地城刷怪任務

標準的地城任務，需要設定 `_TARGETINFOLIST` 和 `_EOT`。

### `quest` - 特殊任務

有專門處理函數的特殊任務：

| 任務 ID | 說明 |
|---------|------|
| `7000G` | 賺取 7000 金幣 |
| `fordraig` | 角鷲之劍任務 |
| `darkLight` | 暗燈任務 |
| `LBC-oneGorgon` | 盧比肯三牛任務 |
| `SSC-goldenchest` | 忍洞金箱任務 |
| `CaveOfSeperation` | 離別洞窟約定之劍 |
| `Scorpionesses` | 蠍女懸賞 |
| `steeltrail` | 鋼試煉任務 |
| `jier` | 吉爾懸賞 |
| `gaintKiller` | 要塞7F刷巨人 |

---

## 完整範例

```json
"DH-6f": {
    "_TYPE": "dungeon",
    "questName": "*新!*[宝箱+刷怪]深雪R6",
    "_TARGETINFOLIST": [
        ["position", "左上", [35, 707]],
        ["position", "左下", [816, 605]],
        ["position", "左下", [80, 873]],
        ["position", "左下", [821, 821]],
        ["chest", "左下", [[0,0,900,1600]]],
        ["chest", "右下", [[0,0,424,1256]]],
        ["stair_DH_R5", "右下", [73, 1240]],
        ["harken", "左上", null]
    ],
    "_EOT": [
        ["press", "DH", ["EdgeOfTown", [1,1]], 1],
        ["press", "DH-R6", "input swipe 650 250 650 900", 1]
    ]
}
```

**流程說明**：
1. 走到 `[35,707]` 位置（左上方向滑動）
2. 走到 `[816,605]` 位置
3. 走到 `[80,873]` 位置
4. 走到 `[821,821]` 位置
5. 在左下區域搜索寶箱
6. 在右下區域搜索寶箱
7. 尋找 `stair_DH_R5` 樓梯並通過
8. 尋找哈肯返回城鎮
9. 執行 `_EOT`：按 `EdgeOfTown` → 按 `DH` → 滑動 → 按 `DH-R6` → 重新開始

---

## 圖片資源

所有圖片位於 `resources/images/` 目錄：

- `chest.png` - 寶箱圖標
- `harken.png` - 哈肯圖標
- `stair_up.png` - 上樓梯
- `stair_down.png` - 下樓梯
- `stair_teleport.png` - 傳送點
- `cursor_0.png` ~ `cursor_3.png` - 地圖光標
- `mapFlag.png` - 地圖標識
- 自定義圖片...
