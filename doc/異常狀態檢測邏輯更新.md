# 更新主程序異常狀態檢測邏輯

## 背景

當前主程序 (`script.py`) 中的 `CheckAbnormalStatus()` 函數使用了較嚴格且不一致的異常狀態檢測邏輯，與經過改進的 `batch_status_analyzer.py` 存在差異。需要統一更新。

## 使用情況分析

`CheckAbnormalStatus()` 函數被調用於以下位置：
- **Line 2223**: AUTO 對話處理（消失後）
- **Line 2260**: AUTO 對話處理（超時後）
- **Line 4910**: StateChest 寶箱狀態處理
- **Line 4988**: StateCombat 戰鬥狀態處理

**結論**: 採用集中式函數，只需更新一處即可影響全部調用點。

## 需要更新的檢測邏輯

### 1. **恐懼 (Fear) 檢測** 
- **當前邏輯**: `diff_val < 7.0`
- **問題**: 無法辨識「寶箱恐懼」變體（實測差異值約 31-35）
- **修改**:
  ```python
  # 修改前
  if diff_val < 7.0:  # 嚴格閾值
  
  # 修改後
  # 寶箱恐懼等變體差異值可能較大 (實測約 33)，放寬門檻
  if diff_val < 40.0:
  ```

### 2. **石化 (Stone) 檢測**
- **當前邏輯**: 使用灰度圖 + `cv2.inRange(180, 255)`
- **問題**: 單通道檢測可能不夠精確
- **修改**:
  ```python
  # 修改前
  gray = cv2.cvtColor(matched_area, cv2.COLOR_BGR2GRAY)
  upper_half = gray[0:20, :]
  white_pixels = cv2.countNonZero(cv2.inRange(upper_half, 180, 255))
  
  # 修改後
  top_half = matched_area[:h_t//2, :]
  top_hsv = cv2.cvtColor(top_half, cv2.COLOR_BGR2HSV)
  white_mask = cv2.inRange(top_hsv, np.array([0, 0, 180]), np.array([180, 40, 255]))
  white_count = cv2.countNonZero(white_mask)
  ```

### 3. **劇毒 (Venom) 檢測**
- **當前邏輯**: `110 < hue < 150 and sat > 50`
- **修改**: 改為更精確的 `abs(hue - 130) < 20 and sat > 50`

### 4. **中毒 (Poison) 檢測**
- **當前邏輯**: `112 < hue < 142`
- **修改**: 改為 `abs(hue - 118) < 20 and sat > 30` (中心點從 127 調整為 118，容差擴大至 20，以兼容 2 號位 Hue ~108 的情況)

### 5. **詛咒 (Cursed) 檢測**
- **當前問題**: 原有 `cursed_icon.png` 模板顏色不正確（偏青色），導致實際紅色圖標匹配度極低 (< 40%)。
- **修改**: 
  - 替換為從實機截圖 (`144100_71`) 提取的正確紅色圖標模板。
  - 驗證後匹配度提升至 95%~100%。

### 6. **麻痺 (Paralysis) 檢測**
- **檢測方式**: 純模板匹配
- **邏輯**: `match_score >= 0.75` 即判定為有效
- **說明**: 麻痺圖標特徵明顯，純輪廓比對已足夠精準，無需額外顏色驗證

### 7. **技能鎖定 (SkillLock) 檢測**
- **檢測方式**: 純模板匹配
- **邏輯**: `match_score >= 0.75` 即判定為有效
- **說明**: 技能鎖定圖標具高飽和度與獨特形狀，模板匹配足夠準確

## 修改範圍

- **檔案**: `D:\Project\wvd\src\script.py`
- **函數**: `Factory.CheckAbnormalStatus` (Line 1319 開始)
- **類型**: 修改現有函數內部邏輯

## 驗證計劃

1. 執行腳本並觀察日誌輸出中的異常檢測結果
2. 確認「寶箱恐懼」能正確被偵測
3. 確認沒有誤報其他狀態

## 風險評估

- **風險等級**: 低
- **影響範圍**: 僅影響異常狀態恢復邏輯
- **回退方案**: 可輕易恢復至原始邏輯
