# 遊戲異常狀態辨識分析報告

本檔案詳述了 WvD 專案中針對角色異常狀態的自動化辨識邏輯、各類狀態的特徵值分析以及在 `batch_status_analyzer.py` 中的實作原理。

## 1. 偵測範圍定義 (ROIS)

偵測區域固定在畫面下方的角色資訊欄位。為了優化效能，每個角色僅對應一個特定的 ROI 矩形區域 (`x, y, w, h`)：

- **角色 0-2 (上排)**: `(120, 1210, 250, 80)`, `(380, 1210, 250, 80)`, `(640, 1210, 250, 80)`
- **角色 3-5 (下排)**: `(120, 1390, 250, 80)`, `(380, 1390, 250, 80)`, `(640, 1390, 250, 80)`

---

## 2. 核心判定流程

所有狀態偵測均遵循「雙門檻」判定機制，以確保高準確率並降低誤判：

### 第一關：模板匹配 (Template Matching)
- **演算法**: `cv2.TM_CCOEFF_NORMED`
- **門檻值**: `match_score >= 0.75`
- **目的**: 檢查圖形「輪廓」是否符合。這是最強的過濾器，普通背景雜訊難以達到此門檻。

### 第二關：特徵演算法驗證
通過第一關後，針對不同類型的圖標進行二次驗證（顏色分析或像素比對）。

---

## 3. 各類異常狀態邏輯分析

### A. 中毒 (Poison) 與 劇毒 (Venom)
- **驗證方式**: HSV 色域平均值分析。
- **中毒邏輯**: 色相 (Hue) 接近 `127` (藍綠色系), 飽和度 (Sat) `> 30`。
- **劇毒邏輯**: 色相 (Hue) 接近 `130` (紫色系), 飽和度 (Sat) `> 50`。

### B. 石化 (Petrified / Stone)
- **驗證方式**: 白色像素占比統計。
- **邏輯**: 
  1. 取圖標上半部區域。
  2. 統計白色範圍 (`HSV: H 0-180, S 0-40, V 180-255`) 的像素數量。
  3. **判定門檻**: 白色像素數量需在 `50 < n < 130` 之間。
- **說明**: 實測若白色面積過大（如 > 200）通常為非活動狀態或其它 UI 干擾。

### C. 恐懼 (Fear / Chest Fear)
- **驗證方式**: 像素差異比對 (`cv2.absdiff`)。
- **邏輯**: 計算偵測區域與網版圖標的平均像素差異 (`diff_val`)。
- **判定門檻**: `diff_val < 40.0`。
- **重要調整**: 
  - 核心恐懼圖標的差異值極低 (< 7.0)。
  - **寶箱恐懼 (Chest Fear)**: 由於出現位置帶有透明背景或浮動於寶箱 UI 上，實測差異值會上升至 `31~35`。
  - 為相容寶箱變體，已將差異門檻放寬至 `40.0`，搭配第一關的高相似度 (0.75) 仍能維持極低誤判率。

### D. 其它狀態 (麻痺、咒詛、技能鎖定)
- **驗證方式**: 純模板匹配。
- **邏輯**: `match_score >= 0.75` 即判定為有效。
- **說明**: 這些狀態圖標特徵極為明顯，純輪廓比對已足夠精準。

---

## 4. 偵測優化建議

1. **背景干擾處理**: 當角色血條後方出現閃爍或半透明特效時，`absdiff` 可能會有些微浮動。目前採用放寬 `Fear` 門檻並嚴格限制 `Match Score` 是最佳平衡點。
2. **多重狀態**: 腳本支援同一 ROI 內同時存在多種異常狀態的掃描，會依照 `FOLDERS` 定義順序依次檢查。
3. **效能**: 建議在高負載環境下僅對當前戰鬥中的角色 ROI 進行掃描，而非全量掃描，以節省 CPU 開銷。

---
*文件更新日期：2026-01-06*
