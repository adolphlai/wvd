# å®ç®±æ¢ç´¢æœºåˆ¶å®Œæ•´é€»è¾‘åˆ†æ

## ğŸ“‹ ç›®å½•
1. [æ•´ä½“æµç¨‹æ¦‚è§ˆ](#æ•´ä½“æµç¨‹æ¦‚è§ˆ)
2. [é…ç½®è§£æé˜¶æ®µ](#é…ç½®è§£æé˜¶æ®µ)
3. [æœç´¢æ‰§è¡Œé˜¶æ®µ](#æœç´¢æ‰§è¡Œé˜¶æ®µ)
4. [ROIåŒºåŸŸå¤„ç†æœºåˆ¶](#roiåŒºåŸŸå¤„ç†æœºåˆ¶)
5. [æ–¹å‘æœç´¢é€»è¾‘](#æ–¹å‘æœç´¢é€»è¾‘)
6. [å†å²è®°å½•ä¼˜åŒ–](#å†å²è®°å½•ä¼˜åŒ–)
7. [äºŒæ¬¡ç¡®è®¤æœºåˆ¶](#äºŒæ¬¡ç¡®è®¤æœºåˆ¶)
8. [æ‰¾åˆ°å®ç®±åçš„å¤„ç†](#æ‰¾åˆ°å®ç®±åçš„å¤„ç†)
9. [å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ](#å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ)

---

## æ•´ä½“æµç¨‹æ¦‚è§ˆ

```
StateDungeon()
  â†“
StateSearch() 
  â†“
StateMap_FindSwipeClick() â† æ ¸å¿ƒæœç´¢å‡½æ•°
  â”œâ”€> éå†æ‰€æœ‰æ–¹å‘ (swipeDir)
  â”œâ”€> æ»‘åŠ¨åœ°å›¾
  â”œâ”€> åº”ç”¨ROIæ’é™¤åŒºåŸŸ
  â”œâ”€> CheckIf() å›¾åƒåŒ¹é…
  â””â”€> è¿”å›å®ç®±åæ ‡æˆ– None
  â†“
æ‰¾åˆ°å®ç®±ï¼Ÿ
  â”œâ”€> æ˜¯ â†’ ç‚¹å‡»å®ç®± â†’ ç‚¹å‡»AutoMove â†’ ç§»åŠ¨åˆ°å®ç®±
  â””â”€> å¦ â†’ ä»ç›®æ ‡åˆ—è¡¨ç§»é™¤è¯¥ç›®æ ‡
```

---

## é…ç½®è§£æé˜¶æ®µ

### 1. quest.json é…ç½®åŠ è½½

```python
# ä» quest.json åŠ è½½é…ç½®
"_TARGETINFOLIST": [
    ["chest", "å³ä¸Š", [[0,0,900,739],[0,529,212,106]]],
    ["harken"]
]
```

### 2. TargetInfo å¯¹è±¡æ„å»º

æ¯ä¸ªç›®æ ‡ä¼šè¢«è½¬æ¢ä¸º `TargetInfo` å¯¹è±¡ï¼š

```python
class TargetInfo:
    target: str          # "chest"
    swipeDir: list       # æ»‘åŠ¨æ–¹å‘åˆ—è¡¨
    roi: list           # æ’é™¤åŒºåŸŸåˆ—è¡¨
```

### 3. swipeDir é»˜è®¤å€¼å¤„ç†

**å¦‚æœ swipeDir ä¸º `None`ï¼š**
```python
value = [None,              # ä¸­å¤®ï¼ˆä¸æ»‘åŠ¨ï¼‰
         [100,250,700,1200],  # å·¦ä¸Š
         [700,250,100,1200],  # å³ä¸Š
         [700,1200,100,250],  # å³ä¸‹
         [100,1200,700,250]]  # å·¦ä¸‹
```

**å¦‚æœ swipeDir ä¸ºå­—ç¬¦ä¸²ï¼ˆå¦‚ "å³ä¸Š"ï¼‰ï¼š**
```python
"å³ä¸Š" â†’ [[700,250,100,1200]]  # å•ä¸ªæ–¹å‘
```

**å¦‚æœ swipeDir ä¸ºè‡ªå®šä¹‰æ•°ç»„ï¼š**
```python
ç›´æ¥ä½¿ç”¨æä¾›çš„æ•°ç»„ï¼Œä¸åšè½¬æ¢
```

### 4. ROI é»˜è®¤å€¼å¤„ç†

**å¯¹äº `target == 'chest'`ï¼š**

```python
# å¦‚æœ roi ä¸º Noneï¼Œå…ˆè®¾ç½®ä¸ºå…¨å±
if value == None:
    value = [[0,0,900,1600]]  # å…¨å±æœç´¢åŒºåŸŸ

# ç„¶åæ·»åŠ é»˜è®¤æ’é™¤åŒºåŸŸï¼ˆUIå…ƒç´ ï¼‰
value += [
    [0,0,900,208],      # é¡¶éƒ¨UI
    [0,1265,900,335],   # åº•éƒ¨UI
    [0,636,137,222],    # å·¦ä¾§UI
    [763,636,137,222],  # å³ä¾§UI
    [336,208,228,77],   # é¡¶éƒ¨ä¸­é—´UI
    [336,1168,228,97]   # åº•éƒ¨ä¸­é—´UI
]
```

**å¦‚æœ roi ä¸º 'default'ï¼š**
```python
value = [
    [0,0,900,1600],     # å…¨å±
    [0,0,900,208],      # é¡¶éƒ¨UI
    [0,1265,900,335],   # åº•éƒ¨UI
    [0,636,137,222],    # å·¦ä¾§UI
    [763,636,137,222],  # å³ä¾§UI
    [336,208,228,77],   # é¡¶éƒ¨ä¸­é—´UI
    [336,1168,228,97]   # åº•éƒ¨ä¸­é—´UI
]
```

---

## æœç´¢æ‰§è¡Œé˜¶æ®µ

### StateMap_FindSwipeClick() å‡½æ•°å®Œæ•´æµç¨‹

```python
def StateMap_FindSwipeClick(targetInfo: TargetInfo):
    target = targetInfo.target      # "chest"
    roi = targetInfo.roi            # æ’é™¤åŒºåŸŸåˆ—è¡¨
    targetPos = None                # åˆå§‹åŒ–ç»“æœ
    
    # 1. åˆå§‹åŒ–å†å²è®°å½•ï¼ˆç”¨äºä¼˜åŒ–ï¼‰
    if target in ['chest', 'harken']:
        direction_history = ChestDirectionHistory()
    
    # 2. éå†æ‰€æœ‰æ»‘åŠ¨æ–¹å‘
    for i in range(len(targetInfo.swipeDir)):
        # 2.1 æ£€æŸ¥åœ°å›¾æ˜¯å¦å¯ç”¨
        scn = ScreenShot()
        if not CheckIf(scn, 'mapFlag'):
            raise KeyError("åœ°å›¾ä¸å¯ç”¨.")
        
        swipeDir = targetInfo.swipeDir[i]  # å½“å‰æ–¹å‘
        
        # 2.2 ç‰¹æ®Šå¤„ç†ï¼šharken è·³è¿‡ä¸­å¤®
        if target == 'harken' and swipeDir is None:
            continue  # è·³è¿‡ä¸­å¤®æœç´¢
        
        # 2.3 å†å²è®°å½•ä¼˜åŒ–ï¼šæ£€æŸ¥æ˜¯å¦åº”è¯¥æœç´¢æ­¤æ–¹å‘
        if direction_history is not None:
            should_search = direction_history.should_search_direction(
                dungeon_name, swipeDir, target=target
            )
            if not should_search:
                logger.info(f"æ–¹å‘å·²ç¡®è®¤æ— ç›®æ ‡ï¼Œè·³è¿‡")
                continue  # è·³è¿‡æ­¤æ–¹å‘
        
        # 2.4 æ‰§è¡Œæ»‘åŠ¨æ“ä½œ
        if swipeDir != None:
            logger.info(f"æ»‘åŠ¨åœ°å›¾: {direction_name}")
            DeviceShell(f"input swipe {swipeDir[0]} {swipeDir[1]} {swipeDir[2]} {swipeDir[3]}")
            Sleep(2)  # ç­‰å¾…æ»‘åŠ¨å®Œæˆ
            scn = ScreenShot()
        
        # 2.5 å›¾åƒåŒ¹é…æœç´¢
        if target == 'position':
            targetPos = CheckIf_ReachPosition(scn, targetInfo)
        elif target.startswith("stair"):
            targetPos = CheckIf_throughStair(scn, targetInfo)
        else:
            # æ ¸å¿ƒï¼šä½¿ç”¨ CheckIf æœç´¢å®ç®±
            targetPos = CheckIf(scn, target, roi)
            
            if targetPos:
                logger.info(f'æ‰¾åˆ° {target}!')
                # è®°å½•æ‰¾åˆ°çš„ç»“æœ
                if direction_history is not None:
                    direction_history.record_search_result(
                        dungeon_name, swipeDir, True, target=target
                    )
                
                # 2.6 äºŒæ¬¡ç¡®è®¤ï¼ˆå¦‚æœæ²¡æœ‰æŒ‡å®šROIï¼‰
                if not roi:
                    Sleep(2)
                    Press([1,1255])  # ç‚¹å‡»åœ°å›¾å…³é—­æŒ‰é’®é™„è¿‘
                    targetPos = CheckIf(ScreenShot(), target, roi)
                break  # æ‰¾åˆ°ç›®æ ‡ï¼Œé€€å‡ºå¾ªç¯
            else:
                # è®°å½•æœªæ‰¾åˆ°çš„ç»“æœ
                if direction_history is not None:
                    direction_history.record_search_result(
                        dungeon_name, swipeDir, False, target=target
                    )
    
    return targetPos  # è¿”å›åæ ‡æˆ– None
```

---

## ROIåŒºåŸŸå¤„ç†æœºåˆ¶

### CutRoI() å‡½æ•°è¯¦è§£

**ROIçš„å¤„ç†é€»è¾‘æ˜¯"æ’é™¤åŒºåŸŸ"ï¼Œä¸æ˜¯"æœç´¢åŒºåŸŸ"ï¼**

```python
def CutRoI(screenshot, roi):
    if roi is None:
        return screenshot  # æ²¡æœ‰ROIï¼Œè¿”å›åŸå›¾
    
    img_height, img_width = screenshot.shape[:2]
    roi_copy = roi.copy()
    
    # ç¬¬ä¸€ä¸ªçŸ©å½¢ï¼šè¿™æ˜¯"ä¿ç•™åŒºåŸŸ"ï¼ˆæœç´¢åŒºåŸŸï¼‰
    roi1_rect = roi_copy.pop(0)  # [x, y, width, height]
    x1, y1, w1, h1 = roi1_rect
    
    # è®¡ç®—è£å‰ªåçš„è¾¹ç•Œ
    roi1_y_start = max(0, y1)
    roi1_y_end = min(img_height, y1 + h1)
    roi1_x_start = max(0, x1)
    roi1_x_end = min(img_width, x1 + w1)
    
    # åˆ›å»ºæ©ç ï¼šä¸åœ¨roi1ä¸­çš„åƒç´ è®¾ä¸º0ï¼ˆé»‘è‰²ï¼‰
    pixels_not_in_roi1_mask = np.ones((img_height, img_width), dtype=bool)
    if roi1_x_start < roi1_x_end and roi1_y_start < roi1_y_end:
        pixels_not_in_roi1_mask[
            roi1_y_start:roi1_y_end, 
            roi1_x_start:roi1_x_end
        ] = False
    
    screenshot[pixels_not_in_roi1_mask] = 0  # å°†ä¸åœ¨roi1çš„åŒºåŸŸè®¾ä¸ºé»‘è‰²
    
    # åç»­çŸ©å½¢ï¼šè¿™äº›éƒ½æ˜¯"æ’é™¤åŒºåŸŸ"ï¼ˆUIå…ƒç´ ï¼‰
    for roi2_rect in roi_copy:
        x2, y2, w2, h2 = roi2_rect
        
        roi2_y_start = max(0, y2)
        roi2_y_end = min(img_height, y2 + h2)
        roi2_x_start = max(0, x2)
        roi2_x_end = min(img_width, x2 + w2)
        
        if roi2_x_start < roi2_x_end and roi2_y_end < roi2_y_end:
            # å°†roi2åŒºåŸŸçš„åƒç´ ä¹Ÿè®¾ä¸º0ï¼ˆæ’é™¤UIå…ƒç´ ï¼‰
            screenshot[roi2_y_start:roi2_y_end, roi2_x_start:roi2_x_end] = 0
    
    return screenshot  # è¿”å›å¤„ç†åçš„å›¾åƒ
```

**å…³é”®ç†è§£ï¼š**
- **ç¬¬ä¸€ä¸ªçŸ©å½¢**ï¼šå®šä¹‰æœç´¢åŒºåŸŸï¼ˆä¿ç•™çš„åŒºåŸŸï¼‰
- **åç»­çŸ©å½¢**ï¼šå®šä¹‰æ’é™¤åŒºåŸŸï¼ˆUIå…ƒç´ ï¼Œè®¾ä¸ºé»‘è‰²ï¼‰

**ç¤ºä¾‹ï¼š**
```python
roi = [
    [0,0,900,1600],      # æœç´¢åŒºåŸŸï¼šå…¨å±
    [0,0,900,208],       # æ’é™¤åŒºåŸŸï¼šé¡¶éƒ¨UI
    [0,1265,900,335]     # æ’é™¤åŒºåŸŸï¼šåº•éƒ¨UI
]
```

---

## æ–¹å‘æœç´¢é€»è¾‘

### 1. æ–¹å‘éå†é¡ºåº

**é»˜è®¤é¡ºåºï¼ˆswipeDir=Noneï¼‰ï¼š**
1. ä¸­å¤®ï¼ˆä¸æ»‘åŠ¨ï¼‰ - `swipeDir = None`
2. å·¦ä¸Š - `[100,250,700,1200]`
3. å³ä¸Š - `[700,250,100,1200]`
4. å³ä¸‹ - `[700,1200,100,250]`
5. å·¦ä¸‹ - `[100,1200,700,250]`

**æ»‘åŠ¨åæ ‡å«ä¹‰ï¼š**
```python
[100, 250, 700, 1200]
#     èµ·ç‚¹     ç»ˆç‚¹
#   (100,250) â†’ (700,1200)
#   ä»å·¦ä¸Šæ»‘åˆ°å³ä¸‹ = æŸ¥çœ‹åœ°å›¾å·¦ä¸ŠåŒºåŸŸ
```

### 2. æ»‘åŠ¨æ‰§è¡Œ

```python
if swipeDir != None:
    DeviceShell(f"input swipe {swipeDir[0]} {swipeDir[1]} {swipeDir[2]} {swipeDir[3]}")
    Sleep(2)  # ç­‰å¾…2ç§’è®©åœ°å›¾ç¨³å®š
```

### 3. æœç´¢å¾ªç¯

- **æ‰¾åˆ°ä¸€ä¸ªæ–¹å‘æœ‰å®ç®±** â†’ ç«‹å³è¿”å›åæ ‡ï¼Œ**ä¸å†æœç´¢å…¶ä»–æ–¹å‘**
- **æ‰€æœ‰æ–¹å‘éƒ½æœç´¢å®Œ** â†’ è¿”å› `None`

**è¿™æ„å‘³ç€ï¼š**
- å¦‚æœç¬¬ä¸€ä¸ªæ–¹å‘ï¼ˆä¸­å¤®ï¼‰æœ‰å®ç®±ï¼Œå°±ä¸ä¼šæœç´¢å…¶ä»–æ–¹å‘
- å¦‚æœå¤šä¸ªæ–¹å‘éƒ½æœ‰å®ç®±ï¼Œåªä¼šè¿”å›ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„

---

## å†å²è®°å½•ä¼˜åŒ–

### ChestDirectionHistory æœºåˆ¶

**æ•°æ®å­˜å‚¨æ ¼å¼ï¼š**
```json
{
  "æ°´è·¯ä¸€å·è¡—": {
    "chest": {
      "å·¦ä¸Š": {"attempts": 5, "found": 0, "last_search": "2025-10-27T12:34:56"},
      "å³ä¸Š": {"attempts": 5, "found": 4, "last_search": "2025-10-27T12:35:12"}
    }
  }
}
```

**åˆ¤æ–­é€»è¾‘ï¼š**

1. **é¦–æ¬¡æœç´¢ï¼ˆæ— è®°å½•ï¼‰ï¼š**
   - è¿”å› `True`ï¼ˆéœ€è¦æœç´¢ï¼‰

2. **æ•°æ®æ”¶é›†é˜¶æ®µï¼ˆattempts < 3ï¼‰ï¼š**
   - è¿”å› `True`ï¼ˆç»§ç»­æœç´¢ï¼Œæ”¶é›†æ•°æ®ï¼‰

3. **ä¼˜åŒ–é˜¶æ®µï¼ˆattempts >= 3ï¼‰ï¼š**
   - `found > 0` â†’ è¿”å› `True`ï¼ˆæ›¾ç»æ‰¾åˆ°è¿‡ï¼Œç»§ç»­æœç´¢ï¼‰
   - `found == 0` â†’ è¿”å› `False`ï¼ˆä»æœªæ‰¾åˆ°ï¼Œè·³è¿‡ï¼‰

**è®°å½•æ›´æ–°ï¼š**
```python
# æ‰¾åˆ°å®ç®±æ—¶
record_search_result(dungeon_name, swipeDir, True)
# â†’ attempts += 1, found += 1

# æ²¡æ‰¾åˆ°æ—¶
record_search_result(dungeon_name, swipeDir, False)
# â†’ attempts += 1, found ä¸å˜
```

**é—®é¢˜ï¼š**
- å¦‚æœå‰3æ¬¡æœç´¢è¿æ°”ä¸å¥½ï¼ˆå®ç®±ä½ç½®éšæœºï¼‰ï¼ŒæŸä¸ªæ–¹å‘3æ¬¡éƒ½æ²¡æ‰¾åˆ°
- åç»­è¯¥æ–¹å‘ä¼šè¢«æ°¸ä¹…è·³è¿‡ï¼Œå³ä½¿è¯¥æ–¹å‘å¯èƒ½æœ‰å®ç®±

---

## äºŒæ¬¡ç¡®è®¤æœºåˆ¶

**è§¦å‘æ¡ä»¶ï¼š** `if not roi:` ï¼ˆæ²¡æœ‰æŒ‡å®šROIæ—¶ï¼‰

**æ‰§è¡Œæµç¨‹ï¼š**
```python
if targetPos:
    if not roi:
        Sleep(2)
        Press([1,1255])  # ç‚¹å‡»åœ°å›¾å…³é—­æŒ‰é’®é™„è¿‘ï¼ˆå®é™…å¯èƒ½ä¸ä¼šå…³é—­ï¼‰
        targetPos = CheckIf(ScreenShot(), target, roi)  # é‡æ–°æ£€æŸ¥
```

**ç›®çš„ï¼š**
- é˜²æ­¢è¯¯è¯†åˆ«
- é€šè¿‡åœ°å›¾ä½ç½®å˜åŒ–æ¥ç¡®è®¤å®ç®±æ˜¯å¦çœŸçš„å­˜åœ¨

**é—®é¢˜ï¼š**
- è¿™ä¸ªé€»è¾‘ä¼¼ä¹æœ‰é—®é¢˜ï¼šç‚¹å‡» `[1,1255]` å¯èƒ½ä¼šå…³é—­åœ°å›¾æˆ–è§¦å‘å…¶ä»–æ“ä½œ
- ç„¶åå†æ¬¡æ£€æŸ¥ï¼Œå¦‚æœç¬¬ä¸€æ¬¡æ˜¯è¯¯è¯†åˆ«ï¼Œç¬¬äºŒæ¬¡å¯èƒ½å°±æ‰¾ä¸åˆ°äº†

---

## æ‰¾åˆ°å®ç®±åçš„å¤„ç†

### StateSearch() ä¸­çš„å¤„ç†

```python
def StateSearch(waitTimer, targetInfoList):
    targetInfo = targetInfoList[0]
    target = targetInfo.target
    
    # æœç´¢å®ç®±
    searchResult = StateMap_FindSwipeClick(targetInfo)
    
    if searchResult == None:
        # æ²¡æ‰¾åˆ°
        if target == 'chest':
            targetInfoList.pop(0)  # ç§»é™¤å½“å‰ç›®æ ‡
            logger.info("æ²¡æœ‰æ‰¾åˆ°å®ç®±. åœæ­¢æ£€ç´¢å®ç®±.")
        return DungeonState.Map, targetInfoList, False
    
    else:
        # æ‰¾åˆ°äº†
        if target in ['harken', 'chest', 'leaveDung', 'position']:
            Press(searchResult)          # ç‚¹å‡»å®ç®±ä½ç½®
            Press([280,1433])            # ç‚¹å‡» AutoMove æŒ‰é’®
            return StateMoving_CheckFrozen(), targetInfoList, True
        else:
            # å…¶ä»–ç›®æ ‡ç±»å‹çš„å¤„ç†...
            pass
```

### StateMoving_CheckFrozen() - ç§»åŠ¨æ£€æµ‹

```python
def StateMoving_CheckFrozen():
    lastscreen = None
    while 1:
        Sleep(0.5)  # æ¯0.5ç§’æ£€æŸ¥ä¸€æ¬¡
        
        _, dungState, screen = IdentifyState()
        
        # å¦‚æœçŠ¶æ€æ”¹å˜ï¼ˆåˆ°è¾¾ç›®æ ‡ã€è¿›å…¥æˆ˜æ–—ã€é‡åˆ°å®ç®±ç­‰ï¼‰
        if dungState != DungeonState.Dungeon:
            break
        
        # æ£€æŸ¥ç”»é¢æ˜¯å¦åœæ­¢ç§»åŠ¨ï¼ˆå¡ä½æ£€æµ‹ï¼‰
        if lastscreen is not None:
            mean_diff = cv2.absdiff(gray1, gray2).mean()/255
            if mean_diff < 0.1:  # ç”»é¢å‡ ä¹æ²¡å˜åŒ–
                break  # åœæ­¢ç§»åŠ¨ï¼Œå¯èƒ½æ˜¯åˆ°è¾¾ç›®æ ‡
        
        lastscreen = screen
```

### StateChest() - å¼€ç®±æµç¨‹

```python
def StateChest():
    # 1. ç­‰å¾…é€‰äººç•Œé¢æˆ–å¼€ç®±ç•Œé¢å‡ºç°
    FindCoordsWithLogging(
        ['dungFlag', 'combatActive', 'chestOpening', 'whowillopenit'],
        [[1,1], [1,1], 'chestFlag'],
        0.5
    )
    
    # 2. å¦‚æœå‡ºç°é€‰äººç•Œé¢
    if CheckIf(scn, 'whowillopenit'):
        # é€‰æ‹©è§’è‰²
        whowillopenit = random.choice(availableChar)
        pos = [258+(whowillopenit%3)*258, 1161+((whowillopenit)//3)%2*184]
        Press(pos)
        
        # å¦‚æœä¸æ˜¯æ™ºèƒ½å¼€ç®±ï¼Œè¿ç»­ç‚¹å‡»è§£é™¤é™·é˜±
        if not setting._SMARTDISARMCHEST:
            for _ in range(8):
                Press([515,934])  # è§£é™¤é™·é˜±æŒ‰é’®
                Sleep(0.3)
    
    # 3. å¦‚æœæ­£åœ¨å¼€ç®±ä¸­
    if CheckIf(scn, 'chestOpening'):
        if setting._SMARTDISARMCHEST:
            ChestOpen()  # æ™ºèƒ½å¼€ç®±ï¼ˆä¸‰è§’æ³¢é¢„æµ‹ï¼‰
        else:
            # ç­‰å¾…å¼€ç®±å®Œæˆ
            FindCoordsWithLogging(
                ['dungFlag', 'combatActive', 'chestFlag'],
                [disarm, disarm, disarm],  # ç»§ç»­ç‚¹å‡»è§£é™¤é™·é˜±
                0.5
            )
    
    # 4. å¼€ç®±å®Œæˆåè¿”å›
    if CheckIf(scn, 'dungFlag'):
        return DungeonState.Dungeon
```

---

## å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šåªæ‰¾åˆ°ç¬¬ä¸€ä¸ªæ–¹å‘çš„å®ç®±

**ç°è±¡ï¼š** å¦‚æœä¸­å¤®æœ‰å®ç®±ï¼Œå°±ä¸ä¼šæœç´¢å…¶ä»–æ–¹å‘çš„å®ç®±

**åŸå› ï¼š** æœç´¢å¾ªç¯åœ¨æ‰¾åˆ°ç¬¬ä¸€ä¸ªå®ç®±åç«‹å³ `break`

**è§£å†³æ–¹æ¡ˆï¼š**
- ä¿®æ”¹ä»£ç ï¼Œæ”¶é›†æ‰€æœ‰æ–¹å‘çš„å®ç®±ä½ç½®
- æˆ–è€…è°ƒæ•´ `swipeDir` é¡ºåºï¼Œä¼˜å…ˆæœç´¢å®ç®±è¾ƒå¤šçš„æ–¹å‘

### é—®é¢˜2ï¼šå†å²è®°å½•ä¼˜åŒ–è¿‡äºæ¿€è¿›

**ç°è±¡ï¼š** æŸä¸ªæ–¹å‘3æ¬¡æ²¡æ‰¾åˆ°åï¼Œæ°¸ä¹…è·³è¿‡ï¼Œä½†è¯¥æ–¹å‘å®é™…å¯èƒ½æœ‰å®ç®±

**è§£å†³æ–¹æ¡ˆï¼š**
1. å¢åŠ  `min_attempts` é˜ˆå€¼ï¼ˆä»3æ”¹ä¸º5æˆ–10ï¼‰
2. æ·»åŠ "é‡ç½®"æœºåˆ¶ï¼Œå®šæœŸæ¸…é™¤å†å²è®°å½•
3. ä¿®æ”¹é€»è¾‘ï¼šå³ä½¿ `found == 0`ï¼Œä¹Ÿå¶å°”æœç´¢ä¸€æ¬¡ï¼ˆä¾‹å¦‚æ¯10æ¬¡å¾ªç¯æœç´¢ä¸€æ¬¡ï¼‰

### é—®é¢˜3ï¼šROIé…ç½®é”™è¯¯å¯¼è‡´æœç´¢åŒºåŸŸä¸å¯¹

**ç°è±¡ï¼š** é…ç½®äº†é”™è¯¯çš„ROIï¼Œå¯¼è‡´æœç´¢ä¸åˆ°å®ç®±

**ç†è§£è¦ç‚¹ï¼š**
- ç¬¬ä¸€ä¸ªçŸ©å½¢æ˜¯**æœç´¢åŒºåŸŸ**ï¼ˆä¿ç•™ï¼‰
- åç»­çŸ©å½¢æ˜¯**æ’é™¤åŒºåŸŸ**ï¼ˆè®¾ä¸ºé»‘è‰²ï¼‰
- å¦‚æœç¬¬ä¸€ä¸ªçŸ©å½¢å¤ªå°ï¼Œå¯èƒ½æœç´¢ä¸åˆ°å®ç®±

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ROIé…ç½®ï¼Œç¡®ä¿ç¬¬ä¸€ä¸ªçŸ©å½¢è¦†ç›–è¶³å¤Ÿå¤§çš„åŒºåŸŸ
- ä½¿ç”¨ `roi = None` æˆ– `roi = [[0,0,900,1600]]` è¿›è¡Œå…¨å±æœç´¢

### é—®é¢˜4ï¼šäºŒæ¬¡ç¡®è®¤æœºåˆ¶çš„é—®é¢˜

**ç°è±¡ï¼š** æ‰¾åˆ°å®ç®±åï¼ŒäºŒæ¬¡ç¡®è®¤å¯èƒ½å¤±è´¥

**åŸå› ï¼š** `Press([1,1255])` å¯èƒ½è§¦å‘æ„å¤–æ“ä½œ

**è§£å†³æ–¹æ¡ˆï¼š**
- ç§»é™¤æˆ–ä¿®æ”¹äºŒæ¬¡ç¡®è®¤é€»è¾‘
- æˆ–è€…æ”¹ç”¨æ›´å®‰å…¨çš„ç¡®è®¤æ–¹å¼ï¼ˆä¾‹å¦‚ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡æ–°æˆªå›¾æ£€æŸ¥ï¼‰

### é—®é¢˜5ï¼šæ»‘åŠ¨ååœ°å›¾ä½ç½®ä¸å‡†ç¡®

**ç°è±¡ï¼š** æ»‘åŠ¨åç­‰å¾…æ—¶é—´ä¸å¤Ÿï¼Œåœ°å›¾è¿˜æ²¡ç¨³å®šå°±æœç´¢

**è§£å†³æ–¹æ¡ˆï¼š**
- å¢åŠ  `Sleep(2)` çš„ç­‰å¾…æ—¶é—´
- æˆ–è€…åœ¨æ»‘åŠ¨åæ£€æŸ¥åœ°å›¾æ˜¯å¦å·²ç¨³å®šï¼ˆæ£€æµ‹UIå…ƒç´ ä½ç½®ï¼‰

### é—®é¢˜6ï¼šå¤šä¸ªå®ç®±ç›®æ ‡çš„å¤„ç†

**ç°è±¡ï¼š** `_TARGETINFOLIST` ä¸­æœ‰å¤šä¸ª `["chest"]` ç›®æ ‡

**å¤„ç†é€»è¾‘ï¼š**
- æ¯æ¬¡ `StateSearch` åªå¤„ç†ç¬¬ä¸€ä¸ªç›®æ ‡
- æ‰¾åˆ°å®ç®±å¹¶å¼€ç®±åï¼Œè¯¥ç›®æ ‡ä¸ä¼šè¢«ç§»é™¤
- éœ€è¦æ‰‹åŠ¨é…ç½®ä¸åŒçš„ `swipeDir` æˆ– `roi` æ¥æœç´¢ä¸åŒåŒºåŸŸçš„å®ç®±

**å»ºè®®é…ç½®ï¼š**
```json
"_TARGETINFOLIST": [
    ["chest", "å·¦ä¸Š", null],
    ["chest", "å³ä¸Š", null],
    ["chest", "å·¦ä¸‹", null],
    ["chest", "å³ä¸‹", null]
]
```

---

## è°ƒè¯•å»ºè®®

### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

åœ¨ä»£ç ä¸­æ·»åŠ æ›´å¤š `logger.debug()` è¾“å‡ºï¼š
- ROIå¤„ç†åçš„å›¾åƒï¼ˆå¯ä»¥ä¿å­˜æˆªå›¾ï¼‰
- æ¯ä¸ªæ–¹å‘çš„æœç´¢ç»“æœ
- åŒ¹é…åº¦åˆ†æ•°

### 2. ä¿å­˜è°ƒè¯•æˆªå›¾

```python
# åœ¨ CheckIf å‡½æ•°ä¸­æ·»åŠ 
if outputMatchResult:
    cv2.imwrite(f"debug_chest_{direction}.png", screenshot)
```

### 3. æ£€æŸ¥å†å²è®°å½•

æŸ¥çœ‹ `chest_direction_history.json`ï¼š
- ç¡®è®¤å„æ–¹å‘çš„ `attempts` å’Œ `found` å€¼
- å¦‚æœæŸä¸ªæ–¹å‘è¢«é”™è¯¯è·³è¿‡ï¼Œå¯ä»¥æ‰‹åŠ¨ç¼–è¾‘JSONé‡ç½®

### 4. æµ‹è¯•ROIé…ç½®

```python
# ä¸´æ—¶ä¿®æ”¹ä»£ç ï¼Œä¿å­˜ROIå¤„ç†åçš„å›¾åƒ
cv2.imwrite(f"roi_processed_{i}.png", search_area)
```

---

## æ€»ç»“

å®ç®±æ¢ç´¢çš„æ ¸å¿ƒæµç¨‹ï¼š

1. **é…ç½®åŠ è½½** â†’ è§£æ `_TARGETINFOLIST`ï¼Œæ„å»º `TargetInfo` å¯¹è±¡
2. **æ–¹å‘éå†** â†’ æŒ‰é¡ºåºéå†æ‰€æœ‰ `swipeDir`ï¼ˆå¯èƒ½è¢«å†å²è®°å½•è·³è¿‡ï¼‰
3. **åœ°å›¾æ»‘åŠ¨** â†’ æ‰§è¡Œæ»‘åŠ¨æ“ä½œï¼Œç­‰å¾…2ç§’
4. **ROIå¤„ç†** â†’ ç¬¬ä¸€ä¸ªçŸ©å½¢å®šä¹‰æœç´¢åŒºåŸŸï¼Œåç»­çŸ©å½¢æ’é™¤UI
5. **å›¾åƒåŒ¹é…** â†’ ä½¿ç”¨ `CheckIf()` åœ¨ROIå¤„ç†åçš„å›¾åƒä¸­æœç´¢
6. **äºŒæ¬¡ç¡®è®¤** â†’ å¦‚æœæ²¡æœ‰ROIï¼Œæ‰§è¡ŒäºŒæ¬¡ç¡®è®¤
7. **è®°å½•ç»“æœ** â†’ æ›´æ–°å†å²è®°å½•ï¼ˆæ‰¾åˆ°/æœªæ‰¾åˆ°ï¼‰
8. **è¿”å›ç»“æœ** â†’ è¿”å›åæ ‡æˆ– `None`

**å…³é”®ç‚¹ï¼š**
- ROIçš„ç¬¬ä¸€ä¸ªçŸ©å½¢æ˜¯æœç´¢åŒºåŸŸï¼Œåç»­æ˜¯æ’é™¤åŒºåŸŸ
- æ‰¾åˆ°ç¬¬ä¸€ä¸ªå®ç®±åç«‹å³è¿”å›ï¼Œä¸ä¼šç»§ç»­æœç´¢å…¶ä»–æ–¹å‘
- å†å²è®°å½•ä¼˜åŒ–å¯èƒ½è¿‡äºæ¿€è¿›ï¼Œå¯¼è‡´æŸäº›æ–¹å‘è¢«æ°¸ä¹…è·³è¿‡
- å¤šä¸ªå®ç®±ç›®æ ‡éœ€è¦åˆ†åˆ«é…ç½®ä¸åŒçš„æ–¹å‘æˆ–ROI

