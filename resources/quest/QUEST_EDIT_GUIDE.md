# quest.json 編輯指南

此文件說明如何編輯 `resources/quest/quest.json` 以自定義你的掛機任務或地城路線。

---

## ⚠️ 重要：兩大唯一原則 (必讀)

在編輯 `quest.json` 時，請務必遵守以下兩點，否則腳本會報錯無法啟動：

1.  **任務 ID (Key) 必須唯一**：例如 `"DH-Church1"` 這個識別碼不能重複。
2.  **`questName` 必須唯一**：這是在選單中顯示的名稱（例如 `"[打王]深雪教會區"`），腳本會根據名稱映射回 ID，因此名稱絕對不能重複。

---

## 一、 檔案結構概覽

`quest.json` 本質上是一個地圖（Dictionary），每個「鍵（Key）」代表一個任務的 ID。

```json
{
    "任務ID": {
        "_TYPE": "任務類型",
        "questName": "任務顯示名稱",
        "_TARGETINFOLIST": [
            // 移動目標序列
        ],
        "_EOT": [
            // 從村莊進入地城的步驟序列
        ]
    }
}
```

---

## 二、 核心欄位說明

### 1. `_TYPE`
- **`dungeon`**: 代表這是一個地城任務，會執行 `_TARGETINFOLIST` 中的移動邏輯。
- **`quest`**: 代表這是一般任務（目前較少直接手動編輯此類）。

### 2. `questName`
- 地圖介面或下拉選單中顯示的名稱。建議加上標籤如 `[寶箱]`、`[打王]` 等。

### 3. `_TARGETINFOLIST` (移動目標)
這是地城腳本的核心。它是一個陣列，腳本會按順序執行其中的移動目標。常見的目標格式如下：

#### A. 指定座標移動 (`position`)
這會在地圖開啟後，先執行滑動，再點擊當前螢幕上的指定座標進行自動尋路。
- **格式**: `["position", "滑動方向", [X, Y]]`
- **範例**: `["position", "右下", [872, 976]]`
- **說明**: 
    1. 腳本會先開啟大地圖。
    2. 根據 `滑動方向`（可選 `"右上", "右下", "左上", "左下"`）移動地圖視野。
    3. **重點**: `[X, Y]` 座標是指**滑動停止後，目標點在螢幕上的位置**。這對於超大地圖（需要滑動才看得到邊緣）非常重要。

#### B. 自動找寶箱 (`chest_auto`)
搜尋主畫面或地圖中的寶箱圖標並點擊。這適用於目前大多數的地城寶箱。
- **格式**: `["chest_auto"]`
- **說明**: 
    1. 腳本會先在主畫面偵測是否有「開啟寶箱」的按鈕。
    2. 若主畫面沒找到，腳本會自動打開地圖並搜尋寶箱圖標。
    3. 若找到則點擊並移動，若地圖中也沒找到，則會嘗試點擊地圖導航盲點。

#### D. 哈肯傳送 (`harken`)
使用哈肯石進行樓層傳送。
- **格式**: `["harken", "滑動方向", [[搜尋ROI]], "樓層圖片名"]`
- **範例**: `["harken", "右上", [[769, 874, 875, 942]], "DH-R5-harken"]`

#### E. 樓梯移動 (`stair`)
點擊地圖上的樓梯圖標。
- **格式**: `["stair_圖標名", "滑動方向", [X, Y]]`
- **範例**: `["stair_DH_R5", "右下", [73, 1240]]`

#### F. 小地圖樓梯偵測 (`minimap_stair`)
**推薦使用**！不需要開啟大地圖，直接偵測右上角小地圖的樓層變化來判斷是否到達。
- **格式**: `["minimap_stair", "滑動方向", [點擊座標], "目標樓層圖片"]`
- **範例**: `["minimap_stair", "右下", [88, 1242], "DH-R5-minimap"]`

---

### 4. `_EOT` (進入地城步驟)
定義從村莊開始，需要點擊哪些按鈕才能進入地城。

- **格式**: `["指令", "目標圖片名稱", 動作, 延遲秒數]`
- **範例**:
    ```json
    "_EOT":[
        ["press", "DH", ["EdgeOfTown", [1, 1]], 2],
        ["press", "stair_DH_Church", "input swipe 650 900 650 250", 2]
    ]
    ```
- **參數說明**:
    - **指令**: 目前主要使用 `"press"` (點擊)。
    - **目標圖片名稱 (`targetPattern`)**: 腳本最终想要「找到並點擊」的目標圖片（例如 `"DH"`）。
    - **動作 (`fallback`)**: 當**找不到**目標圖片時，會執行的「後備動作」或「前置動作」。
        - **執行順序**: 
            1. 腳本會先截圖找「目標圖片名稱」。
            2. **如果找到**: 直接點擊該目標，該步驟結束。
            3. **如果找不到**: 依序執行 `fallback` 列表中的所有動作（例如先點擊 `"EdgeOfTown"`，再點擊 `[1, 1]`），然後等待 `延遲秒數` 並重新循環，直到找到目標或達到超時。
        - **格式範例**:
            - `[1, 1]`: 點擊座標 `[1, 1]`（常用於清除遮擋）。
            - `"input swipe ..."`: 執行滑動。
            - `["圖片A", [1, 1]]`: 依序嘗試點擊圖片A，再點擊座標 `[1, 1]`。
    - **延遲秒數**: 每次循環後的等待時間，也用於給予遊戲動畫跳轉時間。

---

## 三、 實戰範例解析

拿你提供的例子來說：

```json
"DH-Church1":{
    "_TYPE":"dungeon",
    "questName":"[打王]深雪教會區",
    "_TARGETINFOLIST":[
        ["position","右下",[872, 976]],
        ["position","右上",[820, 712]]
    ],
    "_EOT":[
        ["press","DH",["EdgeOfTown",[1,1]], 2],
        ["press","stair_DH_Church","input swipe 650 900 650 250", 2]
    ]
},
```

---

## 四、 常見問題與注意事項

1.  **JSON 格式**: 確保每個大括號 `{}` 和中括號 `[]` 成對。項目之間必須有逗號 `,`，但最後一項後面不可有逗號。
2.  **座標基準**: 所有的座標點擊都是基於遊戲解析度 **1600x900**。
3.  **圖片資源**: 所有的圖片 ID 必須在 `resources/images/` 資料夾中找得到對應的 `.png` 檔案。
4.  **ROI 格式**: `[[x, y, w, h]]` 第一個矩形是搜尋範圍，後續加入的矩形會被視為排除範圍（遮罩）。
5.  **滑動方向**: 如果地圖很大，目標點在邊緣，請務必正確設定 `swipeDir`，否則點擊會無效（因為點在螢幕外面）。

---

## 五、 如何新增一個全新的任務 (Step-by-Step)

1.  **取得進入地城的圖片**: 從村莊到地城入口，每一步轉場按鈕都截圖存入 `resources/images/`。
2.  **確定地圖座標**: 進入地城，打開大地圖，獲取滑動後目標點在螢幕上的 `[X, Y]` 座標。
3.  **編輯 `quest.json`**:
    *   在檔案最後一個 `}` 前，新增一個**唯一且不重複**的 ID。
    *   設定一個**唯一且不重複**的 `questName`。
4.  **重啟腳本**: 在介面的「地城任務」下拉選單中尋找。

---

## 六、 檔案生效與編譯說明

1.  **檔名限制**: 主程式固定讀取 `quest.json`。
2.  **如何生效**:
    *   **開發環境**: 修改 `resources/quest/quest.json` 後重啟。
    *   **資料夾版**: 修改 `_internal/resources/quest/quest.json` 即可生效。
    *   **單一 EXE 版**: 需重新編譯。
