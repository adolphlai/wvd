---
name: 寶箱開啟邏輯
description: 說明智能開箱邏輯，包含 StateChest、ChestOpen、遊標速度分析、陷阱解除。當使用者詢問開箱、陷阱、或遊標分析問題時，應啟用此技能。
---

# 寶箱開啟邏輯 (Chest Opening System)

## 檔案位置
`src/script.py`

## 核心函數

### StateChest() - 寶箱狀態處理
- **位置**: line 2288
- **功能**: 處理寶箱開啟的完整流程

### ChestOpen() - 智能開箱
- **位置**: line 1280
- **功能**: 使用信號處理分析遊標軌跡，預測最佳點擊時機

## 開箱流程

```
檢測到寶箱
    │
    ▼
┌─────────────────┐
│ 選擇開箱人員    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 檢測陷阱類型    │
└────────┬────────┘
         │
    ┌────┴────┐
    │有陷阱   │無陷阱
    ▼         ▼
 ChestOpen   直接開啟
    │
    ▼
 分析遊標軌跡
    │
    ▼
 預測點擊時機
    │
    ▼
 點擊解除陷阱
```

## 遊標速度分析

### triangularWave() - 三角波函數
- **位置**: line 1252
- **功能**: 模擬遊標移動的三角波形

### calculSpd() - 速度計算
- **位置**: line 1255
- **功能**: 使用 scipy.optimize.curve_fit 進行非線性最小二乘擬合

```python
def calculSpd(positions):
    # 1. 收集遊標位置序列
    # 2. 擬合三角波函數
    # 3. 計算週期和速度
    # 4. 返回最佳點擊時機
```

## 陷阱類型

| 陷阱 | 處理方式 |
|------|----------|
| 恐懼陷阱 | 需要特定角色 |
| 毒氣陷阱 | 需要解毒 |
| 一般陷阱 | 遊標點擊 |

## 開箱人員選擇

根據配置自動選擇：
- 盜賊優先
- 恐懼免疫角色
- 最高成功率角色

## 相關圖片資源

- `chestFlag.png` - 寶箱標識
- `whowillopenit.png` - 開箱選擇
- `trapCursor.png` - 陷阱遊標
- `chestOpen.png` - 開箱成功

## 配置項

| 設定 | 說明 |
|------|------|
| `setting._CHESTOPENER` | 指定開箱角色 |
| `setting._AUTOSELECTOPENER` | 自動選擇開箱人 |
