# 寶箱搜尋優化功能說明

## 📋 功能概述

**問題**：原始腳本每次搜尋寶箱時，都會遍歷所有方向（左上、右上、左下、右下），即使某些方向從未找到過寶箱，浪費大量時間。

**解決方案**：基於歷史記錄的智能方向跳過系統，自動學習哪些方向沒有寶箱，並在後續搜尋中跳過這些方向。

---

## ✨ 核心特性

### 1. 自動學習
- 前3次搜尋：收集數據，所有方向都會搜尋
- 第4次開始：跳過從未找到寶箱的方向

### 2. 智能判斷
- ✅ 如果某方向**從未找到寶箱**（經過3次嘗試）→ **跳過**
- ✅ 如果某方向**曾經找到寶箱** → **繼續搜尋**（寶箱可能刷新）
- ✅ 如果某方向**嘗試次數不足3次** → **繼續搜尋**（收集數據）

### 3. 自動保存
- 歷史記錄自動保存到 `chest_direction_history.json`
- 跨次運行保留數據
- 支持多個地城獨立記錄

---

## 📊 效果預期

### 示例：水路一號街

**第1-3次運行**（數據收集階段）：
```
第1次：
  左上 → 沒找到
  右上 → 找到寶箱 ✓
  左下 → 找到寶箱 ✓
  右下 → 沒找到

第2次：
  左上 → 沒找到
  右上 → 找到寶箱 ✓
  左下 → 沒找到
  右下 → 沒找到

第3次：
  左上 → 沒找到
  右上 → 找到寶箱 ✓
  左下 → 沒找到
  右下 → 沒找到

總耗時：每次約 10-12 秒
```

**第4次及以後**（優化階段）：
```
第4次：
  左上 → 跳過 ✗（3次都沒找到）
  右上 → 搜尋 ✓（曾找到過）
  左下 → 搜尋 ✓（曾找到過）
  右下 → 跳過 ✗（3次都沒找到）

總耗時：約 5-6 秒
節省時間：50%！
```

---

## 📁 數據文件格式

### chest_direction_history.json

```json
{
  "水路一號街": {
    "左上": {
      "attempts": 5,
      "found": 0,
      "last_search": "2025-10-27T12:34:56"
    },
    "右上": {
      "attempts": 5,
      "found": 4,
      "last_search": "2025-10-27T12:35:12"
    },
    "左下": {
      "attempts": 5,
      "found": 1,
      "last_search": "2025-10-27T12:35:28"
    },
    "右下": {
      "attempts": 5,
      "found": 0,
      "last_search": "2025-10-27T12:35:44"
    }
  }
}
```

**欄位說明**：
- `attempts`: 嘗試搜尋次數
- `found`: 找到寶箱次數
- `last_search`: 最後搜尋時間

---

## 🔧 使用方法

### 自動啟用

**無需任何配置！** 優化功能已整合到 `script.py`，會自動生效。

### 查看歷史數據

```python
from chest_direction_history import ChestDirectionHistory

history = ChestDirectionHistory()

# 查看某個地城的統計
stats = history.get_statistics("水路一號街")
print(stats)

# 查看推薦搜尋順序
recommended = history.get_recommended_directions("水路一號街")
print(f"推薦順序: {recommended}")
```

### 手動重置數據

如果地城結構改變（遊戲更新），可以刪除 `chest_direction_history.json` 重新收集數據。

---

## 📈 優化效果統計

### 理論計算

假設：
- 4個方向，每個方向滑動+等待 = 2.5秒
- 原始：4個方向 = 10秒
- 優化後：2個方向 = 5秒
- **節省時間：50%**

### 實際場景

**場景1：固定寶箱地城**（如水路一號街）
- 第1-3次：正常速度（收集數據）
- 第4次開始：節省 40-50% 時間
- 長期收益：每次節省 5-7 秒

**場景2：隨機寶箱地城**
- 如果寶箱位置隨機 → 優化效果有限
- 但仍能跳過「永遠沒有寶箱的區域」

---

## ⚙️ 高級設置

### 調整最少嘗試次數

默認需要3次嘗試才開始跳過，可以修改：

```python
# 在 chest_direction_history.py 中
def should_search_direction(self, dungeon_name, direction, min_attempts=3):
    # 改為 5 次
    # 或改為 1 次（激進優化，不推薦）
```

### 強制搜尋某個方向

臨時禁用優化，強制搜尋所有方向：

```python
# 在 StateMap_FindSwipeClick 中註釋掉優化邏輯
# if target == 'chest' and swipeDir is not None and chest_history is not None:
#     should_search = chest_history.should_search_direction(dungeon_name, swipeDir)
#     if not should_search:
#         logger.info(f"寶箱優化: 方向 {chest_history._normalize_direction(swipeDir)} 已確認無寶箱，跳過")
#         continue
```

---

## 🐛 故障排除

### 問題1：優化沒有生效

**檢查**：
1. 確認 `chest_direction_history.py` 在 `src/` 目錄下
2. 查看日誌，是否有「寶箱優化」字樣
3. 檢查是否運行了至少3次

### 問題2：跳過了有寶箱的方向

**原因**：數據收集階段運氣不好，3次都沒找到

**解決**：
1. 刪除 `chest_direction_history.json`
2. 重新運行3次收集數據
3. 或手動編輯 JSON，將 `found` 設為 1

### 問題3：想查看詳細日誌

**方法**：
```python
# 在 script.py 中將 logger.info 改為 logger.debug
logger.debug(f"寶箱優化: 方向 {chest_history._normalize_direction(swipeDir)} 已確認無寶箱，跳過")
```

---

## 📝 開發日誌

### v1.0 (2025-10-27)
- ✅ 實現基於歷史記錄的方向跳過
- ✅ 自動保存/加載數據
- ✅ 整合到 `StateMap_FindSwipeClick`
- ✅ 支持多地城獨立記錄

### 未來計劃
- [ ] GUI界面查看統計數據
- [ ] 支持手動標記「確定無寶箱」
- [ ] 導出熱力圖數據
- [ ] 支持基於時間的數據過期（遊戲更新後自動重置）

---

## 💡 貢獻者

- 核心算法：Claude Code
- 測試與反饋：您（用戶）

如有問題或建議，請提出 Issue！
