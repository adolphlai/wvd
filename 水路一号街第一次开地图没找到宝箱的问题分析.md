# 水路一号街第一次开地图没找到宝箱的问题分析

## 📋 问题描述

根据您的日志：
```
[地圖計時] 進入 DungeonState.Map，開始搜尋目標
  > 搜尋方向: [中央]
[中央] 沒找到 chest
  > 滑動地圖: [左上]
[左上] 沒找到 chest
  > 滑動地圖: [右上]
[右上] 找到 chest!
```

**现象：** 第一次打开地图后，检查"中央"和"左上"都没找到宝箱，滑动到"右上"才找到。

---

## 🔍 问题分析

### **可能的原因1：地图打开时的初始位置不在中央**

#### 问题机制

当打开地图时，游戏可能：
- **记忆上次查看的位置**（如果之前看过右上方向）
- **默认显示某个方向**（不是中央）
- **角色当前位置影响地图视角**（角色在某个位置，地图自动显示该区域）

#### 代码逻辑

```python
# StateMap_FindSwipeClick 中
for i in range(len(targetInfo.swipeDir)):
    swipeDir = targetInfo.swipeDir[i]  # i=0: None（中央）
    
    if swipeDir != None:
        # 滑动地图
        DeviceShell(f"input swipe ...")
        Sleep(2)
        scn = ScreenShot()
    else:
        # 不滑动，直接截图
        logger.info(f"  > 搜尋方向: [中央]")
        # 没有重新截图，使用的是之前循环的截图！
```

**关键问题：**

在 `i=0`（中央）时：
- `swipeDir = None`
- **不执行滑动操作**
- **直接使用之前循环的截图**（`scn = ScreenShot()` 在循环开始时就执行了）
- 但此时地图显示的可能不是中央区域！

---

### **可能的原因2：地图位置状态不一致**

#### 执行流程

```
1. 打开地图 (Press([777,150]))
   └─> 地图可能显示在上次查看的位置（如右上）

2. 第一次循环 (i=0, 中央)
   ├─> scn = ScreenShot()  ← 此时地图显示的可能不是中央
   ├─> swipeDir = None     ← 不滑动
   └─> CheckIf(scn, 'chest', roi)  ← 搜索，但地图不在中央位置

3. 第二次循环 (i=1, 左上)
   ├─> scn = ScreenShot()  ← 地图还在之前的位置
   ├─> 滑动到左上
   └─> CheckIf(scn, 'chest', roi)  ← 搜索左上

4. 第三次循环 (i=2, 右上)
   ├─> scn = ScreenShot()  ← 地图在左上位置
   ├─> 滑动到右上
   └─> CheckIf(scn, 'chest', roi)  ← 搜索右上，找到了！
```

**问题：**
- 第一次循环时，地图打开后的初始位置可能不是中央
- 代码假设"不滑动"就等于"中央位置"，但这个假设可能不成立
- 需要先确认地图确实在中央位置，或者先滑动到中央

---

### **可能的原因3：ROI处理问题**

#### ROI配置

对于 `["chest"]`，ROI 默认是：
```python
roi = [[0,0,900,1600]] + [排除UI区域...]
```

第一个矩形 `[0,0,900,1600]` 是**搜索区域**（全屏）。

**但如果地图不在中央位置：**
- 中央区域的宝箱可能不在当前视野内
- 或者宝箱在视野边缘，被ROI的排除区域排除了

---

## 🎯 根本原因推测

### **最可能的原因：地图打开时不在中央位置**

**证据：**
1. 日志显示"中央"没找到，但"右上"找到了
2. 代码在检查"中央"时不执行滑动，直接搜索
3. 如果地图默认显示的是右上方向，那么：
   - 检查"中央"时看到的是右上区域（但没有宝箱在屏幕中央）
   - 滑动到"左上"时，从右上滑到左上（看不到中央）
   - 滑动到"右上"时，才正确显示了右上区域，找到了宝箱

### **地图打开时的状态**

可能的情况：
1. **游戏记忆上次地图位置** → 如果上次看过右上，这次打开还是右上
2. **角色位置影响地图视角** → 角色在某个位置，地图自动显示该区域
3. **地图默认显示某个方向** → 不是中央

---

## 💡 解决方案思路

### **方案1：打开地图后先确认/重置到中央位置**

在 `StateMap_FindSwipeClick` 开始前，或者第一次循环时：
```python
# 打开地图后，先滑动到中央位置
# 或者在检查中央前，先滑动到中央
if swipeDir is None:
    # 先滑动到中央（如果不在中央）
    # 如何确定中央位置？可能需要一个"重置"操作
```

**问题：** 如何确定当前是否在中央？如何重置到中央？

### **方案2：跳过中央，直接从第一个方向开始搜索**

修改默认顺序，不搜索中央：
```python
# 修改 TargetInfo.swipeDir 的默认值
case None:
    # 跳过中央，直接从4个方向开始
    value = [
        [100,250,700,1200],   # 左上
        [700,250,100,1200],   # 右上
        [700,1200,100,250],   # 右下
        [100,1200,700,250],   # 左下
    ]
```

**优点：**
- 简单直接
- 避免中央位置判断问题

**缺点：**
- 如果中央真的有宝箱，会错过

### **方案3：打开地图后，先执行一个"重置"滑动**

在打开地图后，执行一个滑动操作，确保地图在可预测的位置：
```python
# 在 StateDungeon 打开地图后
Press([777,150])
Sleep(1)

# 执行一个重置滑动（例如滑动到左上再滑动回来）
DeviceShell("input swipe 100 250 700 1200")  # 滑到左上
Sleep(1)
DeviceShell("input swipe 700 1200 100 250")  # 滑回来（相当于中央）
Sleep(1)
```

**问题：** 这种方法不一定能确保在中央，而且浪费时间

---

## 🔎 验证方法

### **方法1：查看截图**

查看 `resources/quest/MuMu-20251101-124850-862.png`，确认：
1. 地图打开时显示的是哪个区域？
2. 是否能看到中央区域？
3. 宝箱在哪里？

### **方法2：添加调试日志**

在代码中添加：
```python
# 第一次循环（中央）时
if i == 0 and swipeDir is None:
    # 保存截图，确认地图位置
    cv2.imwrite(f"debug_center_{time.time()}.png", scn)
    logger.info(f"地图打开时的截图已保存")
```

### **方法3：测试不同情况**

1. **首次进入地下城**：地图打开时显示哪里？
2. **开箱后重新打开地图**：地图位置是否保持？
3. **多次循环**：地图位置是否变化？

---

## 📊 根据日志的推测

根据您的日志：
- 中央没找到
- 左上没找到（滑动后）
- 右上找到了（滑动后）

**推测：**
- 地图打开时可能在**右上方向附近**
- 检查"中央"时，看到的可能是右上区域的边缘，所以没找到
- 滑动到"左上"时，从右上滑到左上（跨过了中央），也没看到中央的宝箱
- 滑动到"右上"时，正确显示了右上区域，找到了宝箱

**或者：**
- 地图打开时在**某个其他位置**
- 中央和左上确实没有宝箱
- 右上有宝箱，所以找到了

---

## 🎯 建议

### **建议1：查看截图确认**

请查看截图，确认：
1. 地图打开时显示的是哪个区域？
2. 是否能从截图中看到宝箱？
3. 宝箱在哪个位置？

### **建议2：修改配置，跳过中央**

如果确定中央没有宝箱，可以修改配置，明确指定4个方向，跳过中央。

### **建议3：修改代码，在检查中央前先滑动到中央**

如果需要在中央搜索，可以添加逻辑，在检查中央前先确保地图在中央位置。

---

## ❓ 需要确认的信息

1. **截图显示的地图位置**：地图打开时显示的是哪个区域？
2. **宝箱位置**：从截图中能否看到宝箱？在哪个方向？
3. **地图行为**：打开地图时，游戏是否会记忆上次查看的位置？

