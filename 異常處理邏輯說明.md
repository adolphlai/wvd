# 異常處理邏輯說明 (IdentifyState Anomaly Handling)

本文件記錄了 `src/script.py` 中 `IdentifyState()` 函數在遇到非預期狀態（狀態機檢查超過 4 次）時的異常處理邏輯。

## 觸發條件
當狀態識別循環計數器 `counter >= 4` 時，腳本會記錄 `看起來遇到了一些不太尋常的情況...` 並執行以下偵測與恢復操作。

## 1. 自動恢復與重置
*   **死而復生 (`RiseAgain`):** 偵測到復活界面時，調用 `RiseAgainReset(reason='combat')`。
*   **世界地圖縮放:** 偵測到 `worldmapflag` 時，嘗試進行縮放調整（點擊 `[100, 1500]` 三次後點擊 `[250, 1500]`）。
*   **沙男恢復 (`sandman_recover`):** 偵測到該標誌時點擊並重新識別狀態。
*   **時間跳躍中斷:** 偵測到 `cursedWheel_timeLeap` 且異常時，會發送 `turn_to_7000G` 消息並退出。

## 2. 善惡值 (Karma) 調整
*   **伏擊 (`ambush`):** 如果 `_KARMAADJUST` 以 `-` 開頭，點擊伏擊按鈕並遞減次數。
*   **積善 (`ignore`):** 如果 `_KARMAADJUST` 以 `+` 開頭，點擊忽略按鈕並遞減次數。

## 3. 對話選項自動清理 (dialogOption)
腳本會循環偵測並嘗試點擊以下對話按鈕，以清除阻塞：
*   `adventurersbones` (冒險者骨頭) - 點擊後記錄「購買了骨頭」。
*   `halfBone` (屍油) - 點擊後記錄「購買了屍油」。
*   `nothanks` (不必了)
*   `strange_things` (奇怪的事)
*   `blessing` (祝福)
*   `DontBuyIt` (不買)
*   `donthelp` (不幫忙)
*   `buyNothing` (不買東西)
*   `Nope` (不)
*   `ignorethequest` (忽略任務)
*   `dontGiveAntitoxin` (不給解毒劑)

## 4. 嚴重異常處理
*   **多人死亡 (`multipeopledead`):** 設置 `_SUICIDE = True` 並嘗試點擊 `skull` 圖標。
*   **下載更新 (`startdownload`):** 自動點擊確認下載。
*   **返回標題 (`totitle`):** 偵測到網路故障標誌時，點擊並返回標題。
*   **退後鍵補償:** 執行兩次 `PressReturn()` (模擬返回鍵/Esc)。
*   **黑屏檢測 (counter > 15):** 比較畫面與全黑模板，若色差過小則警告準備重啟。
*   **重啟遊戲 (counter >= 25):** 認定無法自動恢復，調用 `restartGame()`。

## 5. 畫面盲點嘗試 (counter >= 4)
為了嘗試點掉未知彈窗或恢復焦點，腳本會在每次循環末尾執行：
*   點擊 **`[1, 1]`** (左上角) 三次，每次間隔 0.25 秒。

---
*更新日期: 2025-12-23*
